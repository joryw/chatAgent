# Agent 模式使用指南

## 概述

Agent 模式是一个高级对话模式，让大型语言模型（LLM）能够自主决策何时以及如何使用工具（如联网搜索）来回答用户问题。它实现了 ReAct (Reasoning + Acting) 模式，通过迭代的思考、行动和观察循环来解决复杂问题。

## 特性

### 1. **自主决策**
- 模型自动判断是否需要搜索实时信息
- 无需手动控制搜索开关
- 根据问题类型智能选择工具

### 2. **ReAct 循环**
```
思考 (Reasoning) → 行动 (Acting) → 观察 (Observation) → 再思考
```
- **思考**: 分析问题，规划下一步行动
- **行动**: 调用搜索工具获取信息
- **观察**: 处理工具返回的结果
- **迭代**: 根据需要重复上述过程

### 3. **过程可视化**
- 实时展示 Agent 的思考过程
- 显示工具调用和输入参数
- 展示工具返回的结果
- 所有中间步骤可折叠查看

## 使用方法

### 方式 1: UI 设置面板（推荐）

1. 点击右上角 ⚙️ 图标打开设置面板
2. 在 "🔀 对话模式" 中选择 **agent**
3. 系统会自动切换到 Agent 模式
4. 开始提问，Agent 会自主决策是否使用搜索

### 方式 2: 命令行

```bash
/mode agent
```

切换回 Chat 模式：
```bash
/mode chat
```

查看当前模式：
```bash
/mode
```

## 配置

可以通过环境变量配置 Agent 行为（在 `.env` 文件中）：

```bash
# 默认对话模式
DEFAULT_MODE=agent

# Agent 最大迭代次数（1-10）
AGENT_MAX_ITERATIONS=5

# Agent 最大执行时间（秒，10-300）
AGENT_MAX_EXECUTION_TIME=60

# 是否输出详细日志
AGENT_VERBOSE=true

# 是否启用搜索结果缓存
AGENT_ENABLE_CACHE=true
```

## 适用场景

### ✅ 适合 Agent 模式

1. **需要实时信息**
   - "2024年人工智能最新进展有哪些？"
   - "今天的新闻热点是什么？"
   - "最新的 GPT-4 价格是多少？"

2. **需要多步推理**
   - "比较一下 OpenAI、Anthropic 和 DeepSeek 的最新模型"
   - "分析一下当前科技行业的发展趋势"

3. **不确定是否需要搜索**
   - 让 Agent 自动判断是否需要联网查询

### ❌ 不适合 Agent 模式

1. **简单对话**
   - "你好，介绍一下你自己"
   - "帮我翻译这段话"
   - 建议使用 Chat 模式

2. **已有明确知识**
   - "Python 中的列表推导式怎么用？"
   - "解释一下量子力学的基本原理"
   - 建议使用 Chat 模式，更快更经济

## 示例对话

### 示例 1: 自动触发搜索

**用户**: "DeepSeek R1 模型什么时候发布的？"

**Agent 执行流程**:
1. **💭 思考**: 需要查询 DeepSeek R1 的发布信息
2. **🛠️ 使用工具**: web_search
   - 输入: "DeepSeek R1 发布时间"
3. **💡 工具结果**: 找到 5 条搜索结果...
4. **💭 思考**: 根据搜索结果，信息已经足够
5. **最终回答**: 基于搜索结果的完整回答（包含引用链接）

### 示例 2: 多轮搜索

**用户**: "比较一下当前主流的开源大模型"

**Agent 执行流程**:
1. **💭 思考**: 需要查询当前的开源大模型信息
2. **🛠️ 使用工具**: web_search
   - 输入: "2024 开源大模型排名"
3. **💡 工具结果**: 找到相关信息...
4. **💭 思考**: 还需要更具体的性能对比数据
5. **🛠️ 使用工具**: web_search
   - 输入: "开源大模型性能评测"
6. **💡 工具结果**: 找到评测数据...
7. **最终回答**: 综合两次搜索结果的详细对比

## UI 元素说明

### 思考步骤 (💭 思考中)
- 展示 Agent 的推理过程
- 可折叠查看详情
- 帮助理解 Agent 的决策逻辑

### 工具调用 (🛠️ 使用工具)
- 显示调用的工具名称
- 展示输入参数
- 帮助了解 Agent 的行动

### 工具结果 (💡 工具结果)
- 显示工具返回的数据
- 可折叠查看详细内容
- 帮助验证信息来源

### 最终回答
- Agent 整合信息后的完整回答
- 包含引用链接（如果使用了搜索）
- 独立消息框显示

## 与 Chat 模式的对比

| 特性 | Chat 模式 | Agent 模式 |
|------|----------|----------|
| 搜索控制 | 手动开关 | 自动决策 |
| 多轮搜索 | 不支持 | 支持 |
| 决策过程 | 不可见 | 可视化 |
| 响应速度 | 快 | 较慢（多步推理）|
| Token 消耗 | 低 | 较高 |
| 适用场景 | 简单对话 | 复杂查询 |

## 性能与成本

### Token 消耗
Agent 模式可能产生更多的 token 消耗：
- 每次思考都会消耗 tokens
- 工具调用和结果也计入 tokens
- 多轮迭代会增加总消耗

**建议**:
- 合理设置 `AGENT_MAX_ITERATIONS`（默认 5 次）
- 简单问题使用 Chat 模式
- 监控 token 使用情况

### 响应时间
Agent 模式响应时间较长：
- 每次思考和行动都需要时间
- 搜索工具需要网络请求
- 多轮迭代累加延迟

**建议**:
- 设置合理的 `AGENT_MAX_EXECUTION_TIME`（默认 60 秒）
- 对时间敏感的场景使用 Chat 模式

## 故障排除

### 问题 1: Agent 未初始化

**错误信息**: "⚠️ Agent 未初始化"

**解决方案**:
1. 检查搜索服务是否可用
2. 确认 SearXNG 已正确部署
3. 重启应用

### 问题 2: Agent 执行超时

**错误信息**: "❌ Agent 执行超时"

**解决方案**:
1. 增加 `AGENT_MAX_EXECUTION_TIME`
2. 简化问题描述
3. 切换到 Chat 模式

### 问题 3: Agent 未使用搜索

**原因**:
- Agent 认为已有知识足够回答
- 这是正常的智能决策

**建议**:
- 在问题中明确说明需要"最新"或"实时"信息
- 或切换到 Chat 模式手动控制搜索

## 最佳实践

1. **明确问题类型**
   - 需要实时信息 → Agent 模式
   - 简单对话 → Chat 模式

2. **优化问题描述**
   - 清晰、具体的问题让 Agent 更高效
   - 例如: "查询 2024年最新的..."

3. **监控性能**
   - 注意 token 消耗
   - 观察响应时间
   - 必要时切换模式

4. **合理配置**
   - 根据需求调整迭代次数
   - 平衡性能和成本

## 技术实现

Agent 模式基于以下技术：

- **LangChain**: Agent 框架和工具抽象
- **ReAct Pattern**: 推理和行动循环
- **Tool Integration**: 搜索功能工具化
- **Chainlit**: UI 可视化和交互

详细技术文档请参考：
- [Agent 架构设计](../architecture/design-decisions/agent-mode.md)
- [OpenSpec 提案](../../openspec/changes/add-agent-mode/)

## 相关文档

- [快速开始](quick-start/README.zh-CN.md)
- [搜索功能配置](searxng-deployment.md)
- [模型配置指南](configuration/README.md)

