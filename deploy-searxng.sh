#!/bin/bash

################################################################################
# SearXNG ä¸€é”®éƒ¨ç½²è„šæœ¬
# ç”¨é€”: è‡ªåŠ¨éƒ¨ç½²æœ¬åœ° SearXNG å®ä¾‹ï¼Œé…ç½®å®Œæˆåå³å¯ä½¿ç”¨
################################################################################

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# é…ç½®
SEARXNG_DIR="${HOME}/searxng-local"
SEARXNG_PORT="${SEARXNG_PORT:-8080}"
CHATBOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

################################################################################
# è¾…åŠ©å‡½æ•°
################################################################################

print_header() {
    echo ""
    echo -e "${BLUE}================================================================${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}================================================================${NC}"
    echo ""
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

check_command() {
    if ! command -v $1 &> /dev/null; then
        print_error "$1 æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… $1"
        exit 1
    fi
}

################################################################################
# ä¸»è¦åŠŸèƒ½
################################################################################

# 1. æ£€æŸ¥ä¾èµ–
check_dependencies() {
    print_header "æ£€æŸ¥ç³»ç»Ÿä¾èµ–"
    
    check_command docker
    print_success "Docker å·²å®‰è£…"
    
    # æ£€æŸ¥ Docker Compose (ä¼˜å…ˆä½¿ç”¨å†…ç½®ç‰ˆæœ¬)
    if docker compose version &> /dev/null; then
        COMPOSE_CMD="docker compose"
        print_success "Docker Compose å·²å®‰è£… (ä½¿ç”¨å†…ç½®ç‰ˆæœ¬)"
    elif command -v docker-compose &> /dev/null; then
        COMPOSE_CMD="docker-compose"
        print_success "Docker Compose å·²å®‰è£… (ä½¿ç”¨ç‹¬ç«‹ç‰ˆæœ¬)"
    else
        print_error "Docker Compose æœªå®‰è£…"
        exit 1
    fi
    
    # æ£€æŸ¥ Docker æ˜¯å¦è¿è¡Œ
    if ! docker info &> /dev/null; then
        print_error "Docker æœªè¿è¡Œï¼Œè¯·å…ˆå¯åŠ¨ Docker Desktop"
        exit 1
    fi
    print_success "Docker æœåŠ¡æ­£åœ¨è¿è¡Œ"
    
    # æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
    if lsof -Pi :${SEARXNG_PORT} -sTCP:LISTEN -t >/dev/null 2>&1; then
        print_warning "ç«¯å£ ${SEARXNG_PORT} å·²è¢«å ç”¨"
        read -p "æ˜¯å¦ä½¿ç”¨å…¶ä»–ç«¯å£ï¼Ÿ(è¾“å…¥æ–°ç«¯å£å·ï¼Œæˆ–æŒ‰å›è½¦å–æ¶ˆ): " NEW_PORT
        if [ ! -z "$NEW_PORT" ]; then
            SEARXNG_PORT=$NEW_PORT
            print_info "å°†ä½¿ç”¨ç«¯å£: ${SEARXNG_PORT}"
        else
            print_error "éƒ¨ç½²å–æ¶ˆ"
            exit 1
        fi
    fi
}

# 2. åˆ›å»ºéƒ¨ç½²ç›®å½•
create_directory() {
    print_header "åˆ›å»ºéƒ¨ç½²ç›®å½•"
    
    if [ -d "$SEARXNG_DIR" ]; then
        print_warning "ç›®å½• $SEARXNG_DIR å·²å­˜åœ¨"
        read -p "æ˜¯å¦åˆ é™¤å¹¶é‡æ–°åˆ›å»ºï¼Ÿ(y/N): " CONFIRM
        if [ "$CONFIRM" = "y" ] || [ "$CONFIRM" = "Y" ]; then
            rm -rf "$SEARXNG_DIR"
            print_info "å·²åˆ é™¤æ—§ç›®å½•"
        else
            print_info "å°†ä½¿ç”¨ç°æœ‰ç›®å½•"
        fi
    fi
    
    mkdir -p "$SEARXNG_DIR"
    mkdir -p "$SEARXNG_DIR/searxng-data"
    print_success "ç›®å½•åˆ›å»ºå®Œæˆ: $SEARXNG_DIR"
}

# 3. ç”Ÿæˆé…ç½®æ–‡ä»¶
generate_configs() {
    print_header "ç”Ÿæˆé…ç½®æ–‡ä»¶"
    
    # ç”Ÿæˆ secret key
    SECRET_KEY=$(python3 -c 'import os; print(os.urandom(24).hex())' 2>/dev/null || openssl rand -hex 24)
    print_success "ç”Ÿæˆ secret key: ${SECRET_KEY:0:20}..."
    
    # åˆ›å»º docker-compose.yml
    cat > "$SEARXNG_DIR/docker-compose.yml" <<EOF
version: '3.8'

services:
  searxng:
    image: searxng/searxng:latest
    container_name: searxng
    ports:
      - "${SEARXNG_PORT}:8080"
    volumes:
      - ./searxng-data:/etc/searxng:rw
    environment:
      - SEARXNG_BASE_URL=http://localhost:${SEARXNG_PORT}/
      - SEARXNG_PORT=8080
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
EOF
    print_success "åˆ›å»º docker-compose.yml"
    
    # åˆ›å»º settings.yml (ä½¿ç”¨æœ€å°åŒ–ä½†å®Œæ•´çš„é…ç½®)
    cat > "$SEARXNG_DIR/searxng-data/settings.yml" <<'EOF'
# SearXNG Configuration for AI Agent
# Auto-generated by deploy-searxng.sh
# Minimal but complete configuration

use_default_settings: true

general:
  instance_name: "AI Agent Local SearXNG"
  enable_metrics: false

server:
  secret_key: "SECRET_KEY_PLACEHOLDER"
  limiter: false
  image_proxy: true
  
search:
  safe_search: 1
  autocomplete: ""
  default_lang: "auto"
  formats:
    - html
    - json

ui:
  static_use_hash: true

outgoing:
  request_timeout: 3.0
  max_request_timeout: 10.0
  
enabled_plugins:
  - 'Hash plugin'
  - 'Self Information'
  - 'Tracker URL remover'
EOF
    
    # æ›¿æ¢ secret key
    if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "s|SECRET_KEY_PLACEHOLDER|${SECRET_KEY}|" "$SEARXNG_DIR/searxng-data/settings.yml"
    else
        sed -i "s|SECRET_KEY_PLACEHOLDER|${SECRET_KEY}|" "$SEARXNG_DIR/searxng-data/settings.yml"
    fi
    print_success "åˆ›å»º settings.yml"
}

# 4. å¯åŠ¨ SearXNG
start_searxng() {
    print_header "å¯åŠ¨ SearXNG æœåŠ¡"
    
    cd "$SEARXNG_DIR"
    
    # æ£€æŸ¥æ˜¯å¦å·²æœ‰è¿è¡Œçš„å®¹å™¨
    if docker ps -a --format '{{.Names}}' | grep -q '^searxng$'; then
        print_warning "æ£€æµ‹åˆ°å·²å­˜åœ¨çš„ searxng å®¹å™¨"
        docker stop searxng 2>/dev/null || true
        docker rm searxng 2>/dev/null || true
        print_info "å·²æ¸…ç†æ—§å®¹å™¨"
    fi
    
    # å¯åŠ¨æœåŠ¡
    print_info "æ­£åœ¨å¯åŠ¨ SearXNG å®¹å™¨..."
    $COMPOSE_CMD up -d
    
    print_success "SearXNG å®¹å™¨å·²å¯åŠ¨"
    
    # ç­‰å¾…æœåŠ¡å°±ç»ª
    print_info "ç­‰å¾…æœåŠ¡å¯åŠ¨ (æœ€å¤šç­‰å¾… 60 ç§’)..."
    for i in {1..60}; do
        if curl -s "http://localhost:${SEARXNG_PORT}" > /dev/null 2>&1; then
            print_success "SearXNG æœåŠ¡å·²å°±ç»ªï¼"
            return 0
        fi
        echo -n "."
        sleep 1
    done
    
    print_warning "æœåŠ¡å¯åŠ¨è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æ—¥å¿—: docker logs searxng"
}

# 5. éªŒè¯éƒ¨ç½²
verify_deployment() {
    print_header "éªŒè¯éƒ¨ç½²"
    
    # æ£€æŸ¥å®¹å™¨çŠ¶æ€
    if ! docker ps --format '{{.Names}}' | grep -q '^searxng$'; then
        print_error "å®¹å™¨æœªè¿è¡Œ"
        print_info "æŸ¥çœ‹æ—¥å¿—: docker logs searxng"
        return 1
    fi
    print_success "å®¹å™¨è¿è¡Œä¸­"
    
    # æ£€æŸ¥ Web ç•Œé¢
    print_info "æ£€æŸ¥ Web ç•Œé¢..."
    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:${SEARXNG_PORT}")
    if [ "$HTTP_CODE" = "200" ]; then
        print_success "Web ç•Œé¢å¯è®¿é—®: http://localhost:${SEARXNG_PORT}"
    else
        print_error "Web ç•Œé¢ä¸å¯è®¿é—® (HTTP $HTTP_CODE)"
        return 1
    fi
    
    # æ£€æŸ¥ JSON API
    print_info "æ£€æŸ¥ JSON API..."
    API_RESPONSE=$(curl -s "http://localhost:${SEARXNG_PORT}/search?q=test&format=json")
    if echo "$API_RESPONSE" | grep -q '"results"'; then
        RESULT_COUNT=$(echo "$API_RESPONSE" | grep -o '"results"' | wc -l)
        print_success "JSON API å·¥ä½œæ­£å¸¸ (æµ‹è¯•æœç´¢è¿”å›ç»“æœ)"
    else
        print_error "JSON API ä¸å¯ç”¨"
        print_info "å“åº”å†…å®¹: ${API_RESPONSE:0:200}"
        return 1
    fi
    
    print_success "æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼âœ¨"
}

# 6. é…ç½® AI Agent
configure_ai_agent() {
    print_header "é…ç½® AI Agent"
    
    cd "$CHATBOT_DIR"
    
    # æ£€æŸ¥ .env æ–‡ä»¶
    if [ ! -f .env ]; then
        if [ -f .env.example ]; then
            cp .env.example .env
            print_info "å·²ä» .env.example åˆ›å»º .env æ–‡ä»¶"
        else
            print_warning ".env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·æ‰‹åŠ¨åˆ›å»º"
            return 1
        fi
    fi
    
    # æ›´æ–° SEARXNG_URL
    if grep -q "^SEARXNG_URL=" .env; then
        # æ›´æ–°ç°æœ‰é…ç½®
        if [[ "$OSTYPE" == "darwin"* ]]; then
            # macOS
            sed -i '' "s|^SEARXNG_URL=.*|SEARXNG_URL=http://localhost:${SEARXNG_PORT}|" .env
        else
            # Linux
            sed -i "s|^SEARXNG_URL=.*|SEARXNG_URL=http://localhost:${SEARXNG_PORT}|" .env
        fi
        print_success "å·²æ›´æ–° SEARXNG_URL"
    else
        # æ·»åŠ æ–°é…ç½®
        echo "SEARXNG_URL=http://localhost:${SEARXNG_PORT}" >> .env
        print_success "å·²æ·»åŠ  SEARXNG_URL"
    fi
    
    # æ›´æ–° SEARCH_ENABLED
    if grep -q "^SEARCH_ENABLED=" .env; then
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s|^SEARCH_ENABLED=.*|SEARCH_ENABLED=true|" .env
        else
            sed -i "s|^SEARCH_ENABLED=.*|SEARCH_ENABLED=true|" .env
        fi
        print_success "å·²å¯ç”¨æœç´¢åŠŸèƒ½"
    else
        echo "SEARCH_ENABLED=true" >> .env
        print_success "å·²å¯ç”¨æœç´¢åŠŸèƒ½"
    fi
}

# 7. æ˜¾ç¤ºå®Œæˆä¿¡æ¯
show_completion() {
    print_header "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
    
    echo ""
    echo -e "${GREEN}SearXNG å·²æˆåŠŸéƒ¨ç½²å¹¶è¿è¡Œï¼${NC}"
    echo ""
    echo -e "${BLUE}ğŸ“ æœåŠ¡åœ°å€:${NC}"
    echo "   Web ç•Œé¢: http://localhost:${SEARXNG_PORT}"
    echo "   API åœ°å€: http://localhost:${SEARXNG_PORT}/search?q=test&format=json"
    echo ""
    echo -e "${BLUE}ğŸ“ éƒ¨ç½²ç›®å½•:${NC}"
    echo "   $SEARXNG_DIR"
    echo ""
    echo -e "${BLUE}ğŸ”§ å¸¸ç”¨å‘½ä»¤:${NC}"
    echo "   æŸ¥çœ‹çŠ¶æ€: docker ps -f name=searxng"
    echo "   æŸ¥çœ‹æ—¥å¿—: docker logs searxng -f"
    echo "   åœæ­¢æœåŠ¡: docker stop searxng"
    echo "   å¯åŠ¨æœåŠ¡: docker start searxng"
    echo "   é‡å¯æœåŠ¡: docker restart searxng"
    echo ""
    echo -e "${BLUE}ğŸš€ ä¸‹ä¸€æ­¥:${NC}"
    echo "   1. å¯åŠ¨ AI Agent: chainlit run app.py"
    echo "   2. åœ¨èŠå¤©ç•Œé¢ä½¿ç”¨: /search on"
    echo "   3. æˆ–ä½¿ç”¨ä¸€é”®å¯åŠ¨è„šæœ¬: ./start-all.sh"
    echo ""
    echo -e "${YELLOW}ğŸ’¡ æç¤º:${NC}"
    echo "   - é…ç½®æ–‡ä»¶: $SEARXNG_DIR/searxng-data/settings.yml"
    echo "   - å¯ä»¥è‡ªå®šä¹‰æœç´¢å¼•æ“å’Œå‚æ•°"
    echo "   - æ•…éšœæ’æŸ¥: docs/guides/troubleshooting/searxng.md"
    echo ""
}

################################################################################
# ä¸»æµç¨‹
################################################################################

main() {
    echo ""
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘                                                                â•‘${NC}"
    echo -e "${BLUE}â•‘          ğŸš€ SearXNG ä¸€é”®éƒ¨ç½²è„šæœ¬ v1.0                         â•‘${NC}"
    echo -e "${BLUE}â•‘          ä¸º AI Agent æä¾›æœ¬åœ°æœç´¢æœåŠ¡                         â•‘${NC}"
    echo -e "${BLUE}â•‘                                                                â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    check_dependencies
    create_directory
    generate_configs
    start_searxng
    
    if verify_deployment; then
        configure_ai_agent
        show_completion
        exit 0
    else
        print_error "éƒ¨ç½²éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        print_info "æŸ¥çœ‹æ—¥å¿—: docker logs searxng"
        exit 1
    fi
}

# æ‰§è¡Œä¸»æµç¨‹
main "$@"

