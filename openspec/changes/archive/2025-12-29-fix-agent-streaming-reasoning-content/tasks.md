## 1. 问题分析
- [x] 1.1 分析错误日志和堆栈跟踪
- [x] 1.2 理解 DeepSeek API 对 reasoning_content 的要求
- [x] 1.3 检查现有代码中的 reasoning_content 处理逻辑
- [x] 1.4 识别 LangGraph 流式调用中的消息处理路径

## 2. 修复实现
- [x] 2.1 增强 `DeepSeekWrapper.get_langchain_llm()` 中的消息处理逻辑
  - [x] 2.1.1 确保在 LangGraph 流式调用时正确处理消息历史
  - [x] 2.1.2 检查并修复消息历史中所有 assistant message 的 `reasoning_content` 字段
  - [x] 2.1.3 处理消息索引 1 及后续所有 assistant message
- [x] 2.2 改进错误处理和自动修复机制
  - [x] 2.2.1 在 API 调用前验证消息格式
  - [x] 2.2.2 捕获 `reasoning_content` 相关错误并自动修复
  - [x] 2.2.3 实现重试逻辑，避免因格式问题导致的失败
- [x] 2.3 统一消息处理逻辑
  - [x] 2.3.1 确保同步、异步、流式调用都使用相同的处理逻辑
  - [x] 2.3.2 在 LangGraph 的 `astream` 方法中正确拦截消息
  - [x] 2.3.3 处理消息对象的不同格式（dict vs BaseMessage）

## 3. 测试验证
- [x] 3.1 单元测试
  - [x] 3.1.1 测试消息历史中包含 tool_calls 的 assistant message 处理
  - [x] 3.1.2 测试流式调用时的消息格式修复
  - [x] 3.1.3 测试错误恢复机制
- [ ] 3.2 集成测试
  - [ ] 3.2.1 在 Agent 模式下测试工具调用流程
  - [ ] 3.2.2 测试多轮对话中的消息历史处理
  - [ ] 3.2.3 验证流式输出正常工作
- [ ] 3.3 手动测试
  - [ ] 3.3.1 在 Chainlit UI 中测试 Agent 模式下的搜索功能
  - [ ] 3.3.2 验证不再出现 `reasoning_content` 错误
  - [ ] 3.3.3 检查日志输出，确认修复逻辑正常工作

## 4. 文档更新
- [ ] 4.1 更新代码注释，说明 reasoning_content 处理逻辑
- [ ] 4.2 更新故障排除文档（如果需要）
- [ ] 4.3 更新规范文档，明确 reasoning_content 要求

## 5. 代码审查和清理
- [ ] 5.1 代码审查
  - [ ] 5.1.1 检查代码风格和一致性
  - [ ] 5.1.2 确保没有重复的处理逻辑
  - [ ] 5.1.3 验证错误处理覆盖所有场景
- [ ] 5.2 清理冗余代码
  - [ ] 5.2.1 移除不必要的调试日志（保留关键日志）
  - [ ] 5.2.2 简化重复的消息处理逻辑

