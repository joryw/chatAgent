# web-search 规范变更

## ADDED Requirements

### Requirement: 内联引用链接
系统必须（SHALL）将模型回答中的引用标记转换为可点击的链接,让用户能够直接跳转到来源网页。

#### Scenario: 引用标记识别
- **WHEN** 模型在回答中使用引用标记(如 [1]、[2])
- **THEN** 系统识别这些标记
- **AND** 将标记与对应的搜索结果 URL 建立映射关系

#### Scenario: 引用链接转换
- **WHEN** 模型完成回答生成
- **THEN** 系统将引用标记 [数字] 转换为 Markdown 链接 [[数字]](url)
- **AND** 只转换有效的引用编号(在搜索结果范围内)
- **AND** 保留无效引用的原始格式

#### Scenario: 引用链接点击
- **WHEN** 用户在回答中点击引用链接(如 [[1]](url))
- **THEN** 浏览器打开对应的来源网页
- **AND** 用户能够验证信息的准确性

#### Scenario: 引用列表显示
- **WHEN** 回答包含引用链接
- **THEN** 系统在回答末尾添加"参考文献"部分
- **AND** 列出所有使用的引用及其完整信息
- **AND** 包含编号、标题、URL 和域名

#### Scenario: 无引用情况
- **WHEN** 模型回答中没有使用引用标记
- **THEN** 系统不添加引用链接和引用列表
- **AND** 保持原有的搜索来源显示方式

#### Scenario: 引用编号超出范围
- **WHEN** 模型使用的引用编号超出搜索结果数量
- **THEN** 系统保留该引用的原始文本格式
- **AND** 在日志中记录警告信息
- **AND** 不影响其他有效引用的转换

### Requirement: 引用处理器
系统必须（SHALL）提供引用处理工具类,负责解析、转换和格式化引用内容。

#### Scenario: 引用映射构建
- **WHEN** 系统接收到搜索结果
- **THEN** 引用处理器构建引用编号到 URL 的映射表
- **AND** 存储标题、URL 和域名信息
- **AND** 使用编号(1, 2, 3...)作为索引

#### Scenario: 正则表达式匹配
- **WHEN** 处理器分析回答文本
- **THEN** 使用正则表达式 `\[(\d+)\]` 匹配引用标记
- **AND** 提取方括号中的数字
- **AND** 忽略非引用的方括号内容(如 [abc])

#### Scenario: 安全转换
- **WHEN** 处理器转换引用标记
- **THEN** 验证引用编号的有效性
- **AND** 只转换存在于映射表中的编号
- **AND** 处理转换失败时保持原始内容

## MODIFIED Requirements

### Requirement: 搜索结果处理
系统 SHALL 处理搜索结果并将其提供给语言模型,同时支持内联引用链接功能。

#### Scenario: 注入搜索结果到提示
- **WHEN** 搜索成功返回结果
- **THEN** 系统应当格式化搜索结果(包含编号、标题、来源、摘要)
- **AND** 将格式化后的结果注入到模型提示中
- **AND** 提示模型参考搜索结果回答用户问题
- **AND** 明确指示模型使用 [数字] 格式引用来源

#### Scenario: 搜索结果为空
- **WHEN** 搜索未返回任何结果
- **THEN** 系统应当在提示中说明未找到相关信息
- **AND** 提示模型基于自身知识回答

#### Scenario: 限制结果数量
- **WHEN** 搜索返回大量结果
- **THEN** 系统应当只选择前3-5条最相关的结果
- **AND** 对每条结果的摘要进行截断(最多200字符)

#### Scenario: 引用编号分配
- **WHEN** 格式化搜索结果
- **THEN** 系统为每个搜索结果分配唯一编号
- **AND** 使用 1-based 索引(1, 2, 3...)
- **AND** 按搜索结果顺序分配编号
- **AND** 在提示词和 UI 中保持编号一致性

