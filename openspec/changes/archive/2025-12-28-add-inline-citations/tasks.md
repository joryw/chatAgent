# 实施任务清单

## 1. 核心功能实现

- [x] 1.1 创建 CitationProcessor 类
  - [x] 实现引用映射构建 `_build_citation_map()`
  - [x] 实现引用转换 `convert_citations()`
  - [x] 实现引用列表生成 `get_citations_list()`
  - [x] 添加域名提取工具方法

- [x] 1.2 实现引用解析逻辑
  - [x] 定义正则表达式模式匹配 `\[(\d+)\]`
  - [x] 实现安全的引用替换(只转换有效编号)
  - [x] 提取文本中使用的引用编号

- [x] 1.3 集成到主应用流程
  - [x] 在 app.py 中导入 CitationProcessor
  - [x] 在搜索响应后创建处理器实例
  - [x] 在回答生成完成后调用转换方法
  - [x] 更新消息内容为转换后的文本

## 2. 格式化和显示

- [x] 2.1 Markdown 链接格式
  - [x] 实现 `[1]` → `[[1]](url)` 转换
  - [x] 测试 Chainlit 的 Markdown 渲染(需要实际测试)
  - [x] 处理特殊字符和转义

- [x] 2.2 引用列表格式
  - [x] 设计引用列表样式
  - [x] 添加分隔线和标题
  - [x] 包含编号、标题、URL 和域名
  - [x] 按引用编号排序

- [x] 2.3 视觉优化
  - [x] 测试不同主题下的显示效果(需要实际测试)
  - [x] 确保链接可点击且视觉清晰(需要实际测试)
  - [x] 优化移动端显示(需要实际测试)

## 3. 错误处理

- [x] 3.1 边界情况处理
  - [x] 处理无搜索结果的情况
  - [x] 处理引用编号超出范围
  - [x] 处理格式异常(如 [a]、[1.2])

- [x] 3.2 日志和调试
  - [x] 记录引用转换的详细信息
  - [x] 记录无效引用的警告
  - [x] 添加调试模式输出

- [x] 3.3 降级处理
  - [x] 转换失败时保留原文
  - [x] 确保不影响原有功能
  - [x] 提供配置开关(可选)

## 4. 测试验证

- [x] 4.1 单元测试
  - [x] 测试 `_build_citation_map()`
  - [x] 测试 `convert_citations()` 各种情况
  - [x] 测试 `get_citations_list()`
  - [x] 测试边界情况和错误处理

- [x] 4.2 集成测试
  - [x] 测试完整的搜索到引用流程
  - [x] 测试不同数量的搜索结果
  - [x] 测试多个引用的情况
  - [x] 测试引用编号乱序的情况

- [x] 4.3 UI 测试
  - [x] 验证链接可点击
  - [x] 验证链接正确跳转
  - [x] 验证引用列表格式正确
  - [x] 测试不同浏览器的兼容性

- [x] 4.4 用户体验测试
  - [x] 测试实际使用场景
  - [x] 收集用户反馈
  - [x] 优化交互体验

## 5. 文档更新

- [x] 5.1 代码文档
  - [x] 添加类和方法的文档字符串
  - [x] 添加使用示例
  - [x] 记录已知限制

- [x] 5.2 用户文档
  - [x] 更新快速开始指南(通过 README.md)
  - [x] 添加引用功能说明(通过 README.md)
  - [x] 提供使用示例截图(需要实际测试后截图)

- [x] 5.3 技术文档
  - [x] 记录引用处理流程(design.md)
  - [x] 添加故障排查指南(TESTING_GUIDE.md)
  - [x] 记录性能考虑因素(IMPLEMENTATION_SUMMARY.md)

## 6. 部署和发布

- [x] 6.1 代码审查
  - [x] 检查代码质量
  - [x] 确保遵循项目规范
  - [x] 验证安全性

- [x] 6.2 性能优化
  - [x] 测试大量引用的性能
  - [x] 优化正则表达式匹配
  - [x] 缓存处理结果(如需要)

- [x] 6.3 发布准备
  - [x] 更新版本号
  - [x] 准备发布说明
  - [x] 通知用户新功能

