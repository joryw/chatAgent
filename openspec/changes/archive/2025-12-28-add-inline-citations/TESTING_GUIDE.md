# 内联引用链接测试指南

## 功能概述

内联引用链接功能允许用户直接点击模型回答中的引用标记(如 [1]、[2])跳转到来源网页。

## 测试前准备

### 1. 确认搜索服务可用

```bash
# 检查 SearXNG 是否运行
curl http://localhost:8080/search?q=test&format=json
```

### 2. 启动应用

```bash
chainlit run app.py -w
```

### 3. 启用搜索功能

在聊天界面:
1. 点击设置图标
2. 将"联网搜索"开关打开 ✅

## 测试场景

### 场景1: 基本引用转换

**测试步骤:**
1. 提问: "Python 是什么时候发布的?"
2. 等待模型生成回答
3. 观察回答中的引用标记

**预期结果:**
- ✅ 回答中的 [1]、[2] 等标记显示为带下划线的蓝色链接
- ✅ 点击 [[1]] 能够打开对应的网页
- ✅ 回答末尾显示"📚 参考文献"部分
- ✅ 参考文献列出所有使用的引用及其完整信息

**示例输出:**
```
Python 是一种高级编程语言[[1]](https://python.org)，
由 Guido van Rossum 于 1991 年首次发布[[2]](https://wikipedia.org/python)。

---
**📚 参考文献:**

1. [Python Official Website](https://python.org) - `python.org`
2. [Python - Wikipedia](https://wikipedia.org/python) - `wikipedia.org`
```

### 场景2: 多个引用

**测试步骤:**
1. 提问: "介绍一下机器学习的主要算法"
2. 等待回答完成
3. 检查多个引用的处理

**预期结果:**
- ✅ 所有引用 [1], [2], [3]... 都能正确转换
- ✅ 每个引用链接到对应的搜索结果
- ✅ 参考文献按编号排序
- ✅ 没有重复的引用条目

### 场景3: 无效引用编号

**测试步骤:**
1. 提问并等待回答
2. 如果模型使用了超出搜索结果范围的引用(如只有3个结果但用了[4])

**预期结果:**
- ✅ 有效的引用(1-3)正确转换为链接
- ✅ 无效的引用[4]保持原样,不转换
- ✅ 参考文献只列出有效的引用
- ✅ 日志中记录警告信息

### 场景4: 无引用情况

**测试步骤:**
1. 提问一个不需要引用的问题: "1+1等于几?"
2. 观察回答

**预期结果:**
- ✅ 回答正常显示
- ✅ 没有参考文献部分
- ✅ 仍显示搜索来源(如果执行了搜索)

### 场景5: 搜索禁用

**测试步骤:**
1. 关闭"联网搜索"开关
2. 提问任意问题

**预期结果:**
- ✅ 功能正常,不尝试处理引用
- ✅ 回答不包含引用标记
- ✅ 不显示参考文献

### 场景6: 流式显示

**测试步骤:**
1. 启用搜索
2. 提问
3. 观察回答的生成过程

**预期结果:**
- ✅ 回答逐字符流式显示
- ✅ 在回答完成后,引用标记瞬间转换为链接
- ✅ 参考文献出现在回答末尾
- ✅ 转换过程不影响阅读体验

### 场景7: DeepSeek Reasoner 模型

**测试步骤:**
1. 选择 DeepSeek Reasoner 模型
2. 启用搜索
3. 提问需要推理的问题

**预期结果:**
- ✅ 思考过程正常展开和折叠
- ✅ 正式回答中的引用正确转换
- ✅ 参考文献显示在回答末尾
- ✅ 不影响推理展示功能

## 验证清单

### UI 显示
- [ ] 引用链接显示为蓝色并带下划线
- [ ] 鼠标悬停时显示链接提示
- [ ] 点击链接能在新标签页打开
- [ ] 参考文献格式清晰易读
- [ ] 分隔线美观
- [ ] 移动端显示正常

### 功能正确性
- [ ] 所有有效引用都被转换
- [ ] 无效引用保持原样
- [ ] 引用编号与搜索结果一致
- [ ] 参考文献信息准确
- [ ] URL 正确可访问

### 性能和稳定性
- [ ] 转换过程不影响响应速度
- [ ] 大量引用(>10)时性能良好
- [ ] 错误情况下优雅降级
- [ ] 日志信息完整准确
- [ ] 没有内存泄漏

### 兼容性
- [ ] 与现有搜索功能兼容
- [ ] 与 DeepSeek Reasoner 兼容
- [ ] 与其他模型兼容
- [ ] 不影响无搜索模式

## 日志验证

查看日志确认功能正常:

```bash
# 应看到以下日志
INFO: Built citation map with X entries
INFO: 🔗 Processing inline citations
INFO: Converted X citation(s) in response
INFO: Generated citations list with X reference(s)
INFO: ✅ Inline citations processed successfully
```

## 故障排查

### 引用未转换

**症状**: 引用仍显示为 [1] 而非链接

**检查:**
1. 搜索是否成功执行
2. `search_response` 是否为空
3. 检查日志中的错误信息

### 链接无法点击

**症状**: 引用看起来像链接但无法点击

**检查:**
1. Chainlit 的 Markdown 渲染
2. 浏览器控制台错误
3. URL 格式是否正确

### 参考文献不显示

**症状**: 没有"📚 参考文献"部分

**检查:**
1. 回答中是否包含引用标记
2. `get_citations_list()` 返回值
3. 日志中的处理信息

## 成功标准

测试通过标准:
- ✅ 所有基本场景通过
- ✅ 边界情况处理正确
- ✅ UI 显示符合预期
- ✅ 性能满足要求
- ✅ 日志信息完整
- ✅ 无破坏性变更

