# 实现任务清单

## 1. 设计和规划
- [ ] 1.1 设计 GlobalCitationManager 类接口
- [ ] 1.2 设计引用编号分配算法
- [ ] 1.3 设计引用列表展示格式
- [ ] 1.4 设计会话状态管理方案

## 2. 核心实现
- [ ] 2.1 实现 GlobalCitationManager 类
  - [ ] 2.1.1 实现引用添加方法 (add_citations)
  - [ ] 2.1.2 实现编号分配逻辑 (assign_global_numbers)
  - [ ] 2.1.3 实现引用映射构建 (build_citation_map)
  - [ ] 2.1.4 实现引用列表生成 (generate_citations_list)
  - [ ] 2.1.5 实现会话状态管理 (reset, get_state)
- [ ] 2.2 增强 CitationProcessor 类
  - [ ] 2.2.1 添加 offset 参数支持
  - [ ] 2.2.2 修改编号分配逻辑以支持偏移
  - [ ] 2.2.3 保持向后兼容性
  - [ ] 2.2.4 添加单元测试

## 3. Agent 集成
- [ ] 3.1 修改 ReActAgent 类
  - [ ] 3.1.1 在初始化时创建 GlobalCitationManager 实例
  - [ ] 3.1.2 在工具调用前传递引用管理器上下文
  - [ ] 3.1.3 收集所有工具调用的引用
  - [ ] 3.1.4 在最终回答生成时注入引用列表
- [ ] 3.2 修改 SearchTool 类
  - [ ] 3.2.1 接收引用管理器上下文
  - [ ] 3.2.2 使用全局编号格式化结果
  - [ ] 3.2.3 返回全局编号范围信息

## 4. UI 展示
- [ ] 4.1 设计引用列表展示组件
- [ ] 4.2 实现引用列表 Markdown 格式化
- [ ] 4.3 在最终回答后添加引用列表
- [ ] 4.4 支持折叠/展开引用列表
- [ ] 4.5 优化移动端显示效果

## 5. 会话管理
- [ ] 5.1 在 Chainlit 会话中维护 GlobalCitationManager
- [ ] 5.2 实现会话重置时清空引用
- [ ] 5.3 实现模式切换时的引用管理

## 6. 测试和验证
- [ ] 6.1 单元测试
  - [ ] 6.1.1 测试 GlobalCitationManager 核心功能
  - [ ] 6.1.2 测试 CitationProcessor 偏移量功能
  - [ ] 6.1.3 测试编号分配边界情况
- [ ] 6.2 集成测试
  - [ ] 6.2.1 测试 Agent 多次搜索场景
  - [ ] 6.2.2 测试引用列表生成
  - [ ] 6.2.3 测试会话状态管理
- [ ] 6.3 端到端测试
  - [ ] 6.3.1 测试真实 Agent 对话流程
  - [ ] 6.3.2 验证引用编号的正确性
  - [ ] 6.3.3 验证引用列表的完整性

## 7. 文档更新
- [ ] 7.1 更新 README.md 说明引用管理功能
- [ ] 7.2 更新 Agent 模式文档
- [ ] 7.3 添加引用管理使用示例
- [ ] 7.4 更新 API 文档

## 8. 性能优化
- [ ] 8.1 优化引用映射查找性能
- [ ] 8.2 优化引用列表生成性能
- [ ] 8.3 测试大量引用场景（>50个）

## 9. 错误处理
- [ ] 9.1 处理引用编号冲突
- [ ] 9.2 处理引用丢失情况
- [ ] 9.3 添加异常日志和监控

## 10. 部署和发布
- [ ] 10.1 更新 CHANGELOG
- [ ] 10.2 创建版本标签
- [ ] 10.3 更新部署文档

