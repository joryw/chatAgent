# Change: 添加全局引用管理器

## Why

在 Agent 模式下，Agent 可能会多次调用搜索工具来收集信息。当前实现存在以下问题：

1. **引用编号重复**：每次搜索结果都独立编号（都是 [1][2][3][4][5]），导致引用混乱和重复
2. **无法追踪来源**：用户难以区分多次搜索的不同来源
3. **引用列表分散**：没有统一的引用文章列表，用户需要在多个搜索结果中查找来源

这导致：
- 用户体验混乱，无法清晰了解信息来源
- 引用标记失去意义（多个来源都标记为 [1]）
- 无法验证和追溯信息的准确性

**解决方案**：实现全局引用管理器，为所有搜索结果分配唯一的全局序号，并在最终回答后展示完整的引用文章列表。

## What Changes

### 新增功能

1. **全局引用管理器 (GlobalCitationManager)**
   - 在会话级别维护所有搜索结果的统一引用列表
   - 为每次搜索结果分配连续的全局序号
   - 跟踪引用与搜索查询的关联关系

2. **全局引用编号分配**
   - 第一次搜索：分配 [1-5]
   - 第二次搜索：分配 [6-10]
   - 第 N 次搜索：分配 [N*5+1 - (N+1)*5]
   - 自动处理不同数量的搜索结果

3. **统一引用列表展示**
   - 在 Agent 最终回答后，展示完整的引用文章列表
   - 包含所有搜索的来源信息
   - 按全局序号排序，清晰标注来源

4. **Agent 与引用管理集成**
   - Agent 工具调用时使用全局引用管理器
   - 工具结果自动分配全局序号
   - 最终回答生成时使用全局引用上下文

### 修改内容

1. **CitationProcessor 增强**
   - 支持初始偏移量 (offset) 参数
   - 支持从非1开始的编号
   - 保持向后兼容（Chat 模式仍从1开始）

2. **SearchTool 集成**
   - 接收全局引用管理器实例
   - 返回结果时包含全局序号
   - 格式化结果时使用全局编号

3. **ReActAgent 集成**
   - 维护会话级别的全局引用管理器
   - 在工具调用前传递引用管理器上下文
   - 在最终回答生成时注入引用列表

## Impact

### 影响的规范 (Affected Specs)
- `agent-mode` - 添加全局引用管理需求
- `web-search` - 修改引用编号分配机制

### 影响的代码 (Affected Code)
- `src/search/citation_processor.py` - 增强支持偏移量
- `src/agents/react_agent.py` - 集成全局引用管理器
- `src/agents/tools/search_tool.py` - 使用全局引用上下文
- `app.py` - 在会话中维护全局引用管理器

### 向后兼容性
- ✅ Chat 模式完全不受影响（仍使用独立的 CitationProcessor）
- ✅ 现有 CitationProcessor API 保持兼容
- ✅ 可选的偏移量参数，默认值为0（从1开始）

### 用户体验改进
- ✅ 清晰的全局引用编号，消除重复和混淆
- ✅ 统一的引用文章列表，方便查找和验证来源
- ✅ 更好的信息可追溯性和透明度
- ✅ 提升 Agent 模式的专业性和可信度

