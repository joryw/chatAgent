## ADDED Requirements

### Requirement: 全局引用管理
系统必须（SHALL）在 Agent 模式下实现全局引用管理，为所有搜索结果分配唯一的全局序号，并在最终回答后展示统一的引用文章列表。

#### Scenario: 初始化全局引用管理器
- **WHEN** Agent 会话开始时
- **THEN** 系统创建 GlobalCitationManager 实例
- **AND** 管理器维护在会话状态中
- **AND** 管理器初始化全局编号从 1 开始

#### Scenario: 第一次搜索分配引用编号
- **WHEN** Agent 第一次调用搜索工具返回 5 个结果
- **THEN** 系统分配编号 [1][2][3][4][5]
- **AND** 记录每个引用的完整信息（标题、URL、域名、搜索查询）
- **AND** 更新下一个可用编号为 6

#### Scenario: 第二次搜索分配引用编号
- **WHEN** Agent 第二次调用搜索工具返回 3 个结果
- **THEN** 系统分配编号 [6][7][8]
- **AND** 编号连续递增，不重复
- **AND** 记录这些引用来自第二次搜索

#### Scenario: 多次搜索的连续编号
- **WHEN** Agent 进行 N 次搜索
- **THEN** 每次搜索的结果获得连续递增的全局编号
- **AND** 第 N 次搜索的起始编号 = 前 N-1 次搜索的总结果数 + 1
- **AND** 所有编号在会话内全局唯一

#### Scenario: 工具调用时使用全局编号
- **WHEN** SearchTool 格式化搜索结果
- **THEN** 使用全局引用管理器分配的编号
- **AND** 在结果中显示全局编号而非局部编号
- **AND** 格式: "[全局编号] 标题 - URL"

#### Scenario: 最终回答包含全局引用
- **WHEN** Agent 生成最终回答
- **THEN** 回答中的引用标记使用全局编号
- **AND** 引用格式为 [数字]，数字为全局编号
- **AND** 引用标记可被转换为可点击链接

#### Scenario: 展示统一引用列表
- **WHEN** Agent 完成最终回答生成
- **THEN** 系统在回答末尾添加 "📚 引用文章列表" 部分
- **AND** 列表包含所有搜索的来源信息
- **AND** 按全局编号排序
- **AND** 标注每个引用来自哪次搜索查询

#### Scenario: 引用列表格式
- **WHEN** 生成引用列表
- **THEN** 使用以下格式:
  ```
  ---
  **📚 引用文章列表:**
  
  **第 1 次搜索** (查询: xxx)
  1. [标题1](URL1) - `域名1`
  2. [标题2](URL2) - `域名2`
  
  **第 2 次搜索** (查询: yyy)
  6. [标题6](URL6) - `域名6`
  7. [标题7](URL7) - `域名7`
  ```
- **AND** 按搜索轮次分组展示
- **AND** 每组显示对应的搜索查询

#### Scenario: 仅显示使用的引用
- **WHEN** 回答中只引用了部分搜索结果
- **THEN** 引用列表仅包含实际使用的引用
- **AND** 未被引用的结果不在列表中
- **AND** 减少列表冗余，提升可读性

#### Scenario: 会话重置清空引用
- **WHEN** 用户重置会话（/reset 命令）
- **THEN** 全局引用管理器清空所有引用
- **AND** 全局编号重置为 1
- **AND** 下次对话重新开始编号

#### Scenario: 模式切换保持引用
- **WHEN** 用户在 Agent 模式期间切换到 Chat 模式
- **THEN** 全局引用管理器状态保持不变
- **AND** Chat 模式使用独立的引用处理
- **WHEN** 用户切回 Agent 模式
- **THEN** 继续使用同一全局引用管理器
- **AND** 编号从上次中断处继续

#### Scenario: 引用追踪和日志
- **WHEN** 系统分配和使用全局引用
- **THEN** 记录详细的引用分配日志
- **AND** 日志包含编号范围、搜索查询、结果数量
- **AND** 便于调试和追踪引用问题

#### Scenario: 性能优化
- **WHEN** Agent 进行多次搜索（如5次，25个引用）
- **THEN** 引用查找使用 O(1) 复杂度（字典结构）
- **AND** 引用列表生成在 100ms 内完成
- **AND** 不影响回答生成的响应速度

#### Scenario: 错误处理 - 引用编号冲突
- **WHEN** 检测到引用编号冲突（不应发生）
- **THEN** 系统记录错误日志
- **AND** 尝试修复编号（重新分配）
- **AND** 向用户显示警告信息

#### Scenario: 错误处理 - 引用丢失
- **WHEN** 回答引用了不存在的编号
- **THEN** 系统保留原始引用标记（不转换为链接）
- **AND** 在日志中记录警告
- **AND** 不中断回答生成流程

