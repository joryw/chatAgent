# 联网搜索功能设计文档

## Context
当前聊天智能体基于 Chainlit + LangChain 架构,支持多模型调用。为了增强智能体的实时信息获取能力,需要集成联网搜索功能。用户可以选择性地启用搜索,系统将自动从互联网召回相关信息并提供给模型参考。

**约束条件**:
- 必须保护用户隐私,避免将查询发送到商业搜索引擎
- 搜索延迟应控制在合理范围内(< 5秒)
- 搜索结果需要清晰展示来源,保证可追溯性
- 初始版本不实现复杂的多步搜索或搜索结果精排

## Goals / Non-Goals

**Goals**:
- 提供简单易用的联网搜索开关
- 集成 SearXNG 实现隐私友好的搜索
- 将搜索结果有效地传递给模型
- 在界面上展示搜索源信息
- 支持搜索功能的配置和自定义

**Non-Goals**:
- 不实现多步骤的复杂搜索策略(如 ReAct 模式)
- 不实现搜索结果的向量化存储和检索
- 不支持图片、视频等多媒体搜索
- 不实现搜索历史记录功能
- 不进行深度的搜索结果精排和重排序

## Decisions

### Decision 1: 选择 SearXNG 作为搜索引擎

**理由**:
- **隐私保护**: SearXNG 是开源的元搜索引擎,不追踪用户
- **聚合能力**: 可以聚合多个搜索源(Google、Bing、DuckDuckGo等)的结果
- **可自部署**: 支持自托管,完全掌控数据
- **API 友好**: 提供 JSON API,易于集成

**替代方案**:
- Google Custom Search API: 需要 API 密钥,有配额限制,隐私问题
- Bing Search API: 同样需要密钥和付费
- DuckDuckGo API: 功能有限,结果质量一般
- Tavily API: 专为 AI 设计但需要付费

**决策**: 使用 SearXNG,初期可使用公共实例,后续建议自部署

### Decision 2: 搜索结果注入方式

采用直接注入到系统提示的方式:

```
系统提示:
你是一个AI助手...

[搜索结果]
基于用户问题,以下是相关的网络搜索结果:

1. 标题: xxx
   来源: example.com
   摘要: ...

2. 标题: yyy
   来源: another.com
   摘要: ...

[/搜索结果]

用户问题: {user_query}
```

**理由**:
- 简单直接,模型可以自然地理解和引用搜索结果
- 易于实现,不需要复杂的 RAG 架构
- 符合第一版快速实现的目标

**替代方案**:
- 使用 LangChain 的 ReAct Agent: 过于复杂,涉及多次调用
- 向量化存储: 增加复杂度,当前不需要
- Tool calling: 需要模型支持 function calling,限制模型选择

### Decision 3: UI 交互设计

在 Chainlit 界面中使用 `cl.ChatSettings` 实现搜索开关:

```python
@cl.on_chat_start
async def start():
    settings = await cl.ChatSettings([
        cl.Switch(
            id="enable_search",
            label="联网搜索",
            initial=False
        )
    ]).send()
```

**理由**:
- Chainlit 原生支持设置面板
- 用户体验好,易于切换
- 设置持久化到会话中

### Decision 4: 搜索触发策略

**第一版**: 如果用户启用了搜索开关,每次用户消息都触发搜索

**未来优化**:
- 使用小模型判断是否需要搜索
- 支持用户显式触发(如输入 `/search` 命令)
- 基于问题类型自动判断

### Decision 5: 模块架构

```
src/search/
├── __init__.py
├── searxng_client.py    # SearXNG API 封装
├── search_service.py     # 搜索服务主逻辑
├── models.py             # 搜索结果数据模型
└── formatter.py          # 结果格式化工具
```

**设计原则**:
- 单一职责: 每个模块专注一个功能
- 可测试性: 易于进行单元测试和mock
- 可扩展性: 未来可以轻松添加其他搜索源

## Risks / Trade-offs

### Risk 1: SearXNG 服务可用性
**风险**: 如果使用公共 SearXNG 实例,可能不稳定或被限流
**缓解**:
- 在文档中提供自部署指南
- 实现超时和重试机制
- 搜索失败时降级到无搜索模式,不影响基础对话

### Risk 2: 搜索延迟影响用户体验
**风险**: 搜索可能需要 2-5 秒,影响响应速度
**缓解**:
- 在 UI 显示搜索进度指示器
- 设置合理的超时时间(5秒)
- 考虑使用异步搜索,先返回初步回答

### Risk 3: Token 消耗增加
**风险**: 搜索结果会增加提示长度,消耗更多 token
**缓解**:
- 限制搜索结果数量(默认3-5条)
- 对搜索结果进行摘要和截断
- 记录 token 使用情况,为优化提供数据

### Risk 4: 搜索结果质量
**风险**: 搜索结果可能不相关或质量低
**缓解**:
- 提示模型批判性地使用搜索结果
- 在 UI 展示来源,让用户自行判断
- 未来可以添加相关性评分和过滤

## Migration Plan

### Phase 1: 核心功能 (MVP)
1. 实现基础的 SearXNG 集成
2. 添加 UI 开关
3. 实现简单的结果注入

### Phase 2: 优化体验
1. 改进搜索结果展示
2. 优化提示模板
3. 添加搜索策略优化

### Phase 3: 高级特性
1. 智能搜索触发
2. 搜索结果缓存
3. 多轮搜索支持

### 回滚计划
如果搜索功能出现问题:
1. 可以通过关闭搜索开关禁用功能
2. 不影响现有的基础对话能力
3. 可以快速回滚代码变更

## Open Questions

1. **SearXNG 实例**: 使用公共实例还是要求用户自部署?
   - 建议: 文档中提供两种方案,默认使用知名的公共实例

2. **搜索查询优化**: 是否需要对用户输入进行改写以提高搜索质量?
   - 建议: 第一版直接使用用户输入,后续根据效果决定

3. **多语言支持**: 搜索结果的语言处理?
   - 建议: 根据用户查询语言自动处理,暂不做特殊处理

4. **缓存策略**: 是否需要缓存搜索结果?
   - 建议: 第一版不实现,后续根据成本和性能需求决定

