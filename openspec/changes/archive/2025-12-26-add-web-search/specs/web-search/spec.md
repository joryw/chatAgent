## ADDED Requirements

### Requirement: 搜索开关控制
系统 SHALL 在聊天界面提供联网搜索开关,允许用户启用或禁用搜索功能。

#### Scenario: 用户启用搜索
- **WHEN** 用户在聊天界面打开联网搜索开关
- **THEN** 系统将在后续对话中启用搜索功能
- **AND** 界面显示搜索已启用的状态

#### Scenario: 用户禁用搜索
- **WHEN** 用户在聊天界面关闭联网搜索开关
- **THEN** 系统将在后续对话中禁用搜索功能
- **AND** 界面显示搜索已禁用的状态

#### Scenario: 默认状态
- **WHEN** 用户首次进入聊天界面
- **THEN** 搜索开关默认为关闭状态

### Requirement: SearXNG 集成
系统 SHALL 集成 SearXNG 搜索引擎,提供联网搜索能力。

#### Scenario: 成功搜索
- **WHEN** 系统需要执行搜索且 SearXNG 服务可用
- **THEN** 系统向 SearXNG 发送搜索请求
- **AND** 接收并解析搜索结果(包括标题、URL、摘要)

#### Scenario: 搜索超时
- **WHEN** 搜索请求超过5秒未返回
- **THEN** 系统应当终止搜索请求
- **AND** 降级到无搜索模式继续对话
- **AND** 在界面显示搜索超时提示

#### Scenario: 服务不可用
- **WHEN** SearXNG 服务不可达或返回错误
- **THEN** 系统应当捕获错误
- **AND** 降级到无搜索模式继续对话
- **AND** 在界面显示搜索服务不可用提示

### Requirement: 搜索触发机制
当搜索功能启用时,系统 SHALL 在适当时机触发搜索。

#### Scenario: 用户发送消息时触发搜索
- **WHEN** 用户启用了搜索功能并发送新消息
- **THEN** 系统应当基于用户消息内容触发搜索
- **AND** 在界面显示搜索进行中的状态

#### Scenario: 搜索功能未启用
- **WHEN** 用户未启用搜索功能
- **THEN** 系统不应触发任何搜索请求
- **AND** 直接使用模型生成回答

### Requirement: 搜索结果处理
系统 SHALL 处理搜索结果并将其提供给语言模型。

#### Scenario: 注入搜索结果到提示
- **WHEN** 搜索成功返回结果
- **THEN** 系统应当格式化搜索结果(包含标题、来源、摘要)
- **AND** 将格式化后的结果注入到模型提示中
- **AND** 提示模型参考搜索结果回答用户问题

#### Scenario: 搜索结果为空
- **WHEN** 搜索未返回任何结果
- **THEN** 系统应当在提示中说明未找到相关信息
- **AND** 提示模型基于自身知识回答

#### Scenario: 限制结果数量
- **WHEN** 搜索返回大量结果
- **THEN** 系统应当只选择前3-5条最相关的结果
- **AND** 对每条结果的摘要进行截断(最多200字符)

### Requirement: 搜索源展示
系统 SHALL 在聊天界面展示搜索来源信息,提高透明度。

#### Scenario: 展示搜索源列表
- **WHEN** 模型回答基于搜索结果
- **THEN** 系统应当在回答下方展示使用的搜索源
- **AND** 每个搜索源包含标题、URL和简短摘要
- **AND** 搜索源以可点击链接形式展示

#### Scenario: 无搜索源
- **WHEN** 回答未使用搜索结果
- **THEN** 系统不应展示搜索源信息

#### Scenario: 搜索源引用标记
- **WHEN** 模型在回答中引用特定搜索结果
- **THEN** 系统应当在引用处添加上标序号标记
- **AND** 序号对应搜索源列表中的顺序

### Requirement: 搜索配置
系统 SHALL 支持配置搜索相关参数。

#### Scenario: SearXNG 服务地址配置
- **WHEN** 系统启动时
- **THEN** 从环境变量读取 SearXNG 服务地址
- **AND** 如果未配置则使用默认公共实例
- **AND** 验证服务地址的有效性

#### Scenario: 搜索参数配置
- **WHEN** 系统初始化搜索配置时
- **THEN** 应当加载以下可配置参数:
  - 搜索结果数量(默认5条)
  - 搜索超时时间(默认5秒)
  - 搜索语言偏好(默认自动)
  - 结果摘要最大长度(默认200字符)

#### Scenario: 配置验证
- **WHEN** 加载搜索配置时
- **THEN** 系统应当验证配置值的有效性
- **AND** 对于无效配置使用默认值
- **AND** 记录配置加载日志

### Requirement: 错误处理与降级
系统 SHALL 优雅地处理搜索功能的错误,不影响基础对话能力。

#### Scenario: 搜索失败降级
- **WHEN** 搜索功能出现任何错误(超时、服务不可用、解析失败等)
- **THEN** 系统应当记录错误日志
- **AND** 降级到无搜索模式
- **AND** 继续正常对话流程
- **AND** 向用户显示友好的错误提示

#### Scenario: 部分搜索结果失败
- **WHEN** 部分搜索结果无法解析或格式错误
- **THEN** 系统应当跳过错误的结果
- **AND** 使用成功解析的结果继续处理
- **AND** 在日志中记录解析失败的详情

#### Scenario: 网络连接问题
- **WHEN** 因网络问题无法连接 SearXNG 服务
- **THEN** 系统应当快速失败(不超过5秒)
- **AND** 显示网络连接问题提示
- **AND** 建议用户检查网络或关闭搜索功能

