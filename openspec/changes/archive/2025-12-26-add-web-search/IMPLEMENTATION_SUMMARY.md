# è”ç½‘æœç´¢åŠŸèƒ½å®žæ–½æ€»ç»“

## æ¦‚è¿°

æœ¬æ–‡æ¡£æ€»ç»“äº† `add-web-search` å˜æ›´ææ¡ˆçš„å®žæ–½æƒ…å†µã€‚è¯¥åŠŸèƒ½ä¸º AI Agent æ·»åŠ äº†åŸºäºŽ SearXNG çš„è”ç½‘æœç´¢èƒ½åŠ›ï¼Œå…è®¸ç”¨æˆ·èŽ·å–å®žæ—¶ä¿¡æ¯ã€‚

**å®žæ–½æ—¥æœŸï¼š** 2024-12-26  
**çŠ¶æ€ï¼š** âœ… å·²å®Œæˆ  
**ç‰ˆæœ¬ï¼š** v1.0

---

## å®žæ–½çš„åŠŸèƒ½

### 1. æœç´¢æ¨¡å—æž¶æž„ (`src/search/`)

åˆ›å»ºäº†å®Œæ•´çš„æœç´¢æ¨¡å—ï¼ŒåŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š

#### 1.1 æ•°æ®æ¨¡åž‹ (`models.py`)
- `SearchResult` - å•ä¸ªæœç´¢ç»“æžœçš„æ•°æ®ç»“æž„
- `SearchResponse` - å®Œæ•´æœç´¢å“åº”çš„æ•°æ®ç»“æž„

#### 1.2 SearXNG å®¢æˆ·ç«¯ (`searxng_client.py`)
- å¼‚æ­¥ HTTP å®¢æˆ·ç«¯å°è£…
- æ”¯æŒé…ç½®è¶…æ—¶ã€æœ€å¤§ç»“æžœæ•°
- å¥åº·æ£€æŸ¥åŠŸèƒ½
- å®Œå–„çš„é”™è¯¯å¤„ç†

#### 1.3 æœç´¢æœåŠ¡ (`search_service.py`)
- æœç´¢æœåŠ¡ä¸»é€»è¾‘
- ç»“æžœæ ¼å¼åŒ–å’Œå¤„ç†
- æœåŠ¡å¯ç”¨æ€§æ£€æŸ¥

#### 1.4 ç»“æžœæ ¼å¼åŒ–å™¨ (`formatter.py`)
- å°†æœç´¢ç»“æžœæ ¼å¼åŒ–ä¸º LLM æç¤º
- ç”Ÿæˆ UI å±•ç¤ºçš„æœç´¢æºä¿¡æ¯
- å†…å®¹æˆªæ–­å’Œæ‘˜è¦

### 2. é…ç½®ç®¡ç†

#### 2.1 æœç´¢é…ç½®ç±» (`src/config/search_config.py`)
```python
class SearchConfig:
    enabled: bool
    searxng_url: str
    timeout: float
    max_results: int
    max_content_length: int
    language: str
    safesearch: int
```

#### 2.2 çŽ¯å¢ƒå˜é‡æ”¯æŒ
åœ¨ `env.example` ä¸­æ·»åŠ ï¼š
```bash
SEARCH_ENABLED=false
SEARXNG_URL=https://searx.be
SEARCH_TIMEOUT=5.0
SEARCH_MAX_RESULTS=5
SEARCH_MAX_CONTENT_LENGTH=200
SEARCH_LANGUAGE=auto
SEARCH_SAFESEARCH=1
```

### 3. UI é›†æˆ (Chainlit)

#### 3.1 æœç´¢å¼€å…³
- ä½¿ç”¨ `cl.ChatSettings` å’Œ `cl.Switch` å®žçŽ°
- ç”¨æˆ·å¯ä»¥éšæ—¶å¯ç”¨/ç¦ç”¨æœç´¢
- è®¾ç½®æŒä¹…åŒ–åˆ°ä¼šè¯ä¸­

#### 3.2 æœç´¢çŠ¶æ€æ˜¾ç¤º
- æœç´¢è¿›è¡Œä¸­ï¼šæ˜¾ç¤º "ðŸ” æ­£åœ¨æœç´¢ç›¸å…³ä¿¡æ¯..."
- æœç´¢å®Œæˆï¼šæ˜¾ç¤º "âœ… æ‰¾åˆ° X æ¡æœç´¢ç»“æžœ"
- æœç´¢å¤±è´¥ï¼šæ˜¾ç¤ºè­¦å‘Šä¿¡æ¯

#### 3.3 æœç´¢æºå±•ç¤º
- åœ¨å›žç­”åŽå±•ç¤ºæœç´¢æ¥æº
- åŒ…å«æ ‡é¢˜ã€é“¾æŽ¥ã€æ¥æºåŸŸå
- æ ¼å¼åŒ–ä¸º Markdown ä¾¿äºŽé˜…è¯»

### 4. æ ¸å¿ƒåŠŸèƒ½å®žçŽ°

#### 4.1 æœç´¢è§¦å‘é€»è¾‘
```python
# åœ¨ app.py çš„ @cl.on_message ä¸­
if search_enabled and search_service:
    search_response = await search_service.search(user_message)
```

#### 4.2 ç»“æžœæ³¨å…¥
```python
# ä½¿ç”¨ build_system_message_with_search å‡½æ•°
system_message = build_system_message_with_search(
    DEFAULT_SYSTEM_MESSAGE,
    search_results_text,
)
```

#### 4.3 æç¤ºæ¨¡æ¿ä¿®æ”¹
åœ¨ `src/prompts/templates.py` ä¸­æ·»åŠ ï¼š
```python
def build_system_message_with_search(
    base_message: str,
    search_results: Optional[str] = None,
) -> str:
    # å°†æœç´¢ç»“æžœæ³¨å…¥åˆ°ç³»ç»Ÿæ¶ˆæ¯ä¸­
```

### 5. é”™è¯¯å¤„ç†å’Œé™çº§

#### 5.1 æœç´¢æœåŠ¡ä¸å¯ç”¨
- æ£€æµ‹æœåŠ¡å¥åº·çŠ¶æ€
- ä¸å¯ç”¨æ—¶ç¦ç”¨æœç´¢åŠŸèƒ½
- ä¸å½±å“åŸºç¡€å¯¹è¯èƒ½åŠ›

#### 5.2 æœç´¢è¶…æ—¶
- é…ç½®è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ 5 ç§’ï¼‰
- è¶…æ—¶åŽä¼˜é›…é™çº§
- è®°å½•é”™è¯¯æ—¥å¿—

#### 5.3 æœç´¢ç»“æžœä¸ºç©º
- æ˜¾ç¤º "æœªæ‰¾åˆ°ç›¸å…³æœç´¢ç»“æžœ"
- ç»§ç»­ä½¿ç”¨æ¨¡åž‹çŸ¥è¯†å›žç­”
- ä¸ä¸­æ–­å¯¹è¯æµç¨‹

#### 5.4 ç½‘ç»œé”™è¯¯
- æ•èŽ·æ‰€æœ‰ HTTP å¼‚å¸¸
- æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
- è‡ªåŠ¨é™çº§åˆ°æ— æœç´¢æ¨¡å¼

### 6. æ–‡æ¡£æ›´æ–°

#### 6.1 README.md
- æ·»åŠ è”ç½‘æœç´¢åŠŸèƒ½è¯´æ˜Ž
- æ›´æ–°çŽ¯å¢ƒå˜é‡é…ç½®ç¤ºä¾‹
- æ·»åŠ ä½¿ç”¨æŒ‡å—

#### 6.2 SearXNG éƒ¨ç½²æŒ‡å—
åˆ›å»º `docs/guides/searxng-setup.md`ï¼ŒåŒ…å«ï¼š
- ä½¿ç”¨å…¬å…±å®žä¾‹çš„æ–¹æ³•
- Docker éƒ¨ç½²æŒ‡å—
- æ‰‹åŠ¨å®‰è£…æ­¥éª¤
- æ•…éšœæŽ’æŸ¥æŒ‡å—
- å®‰å…¨å»ºè®®

#### 6.3 ä¾èµ–æ›´æ–°
åœ¨ `requirements.txt` ä¸­æ·»åŠ ï¼š
```
httpx>=0.23.0,<0.25.0
```

---

## æŠ€æœ¯å®žçŽ°ç»†èŠ‚

### æž¶æž„è®¾è®¡

éµå¾ªé¡¹ç›®çš„ 5 å±‚æž¶æž„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Application Layer              â”‚  app.py (Chainlit UI)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Business Layer                 â”‚  æ¶ˆæ¯å¤„ç†é€»è¾‘
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Search/Memory Layer            â”‚  src/search/ (æ–°å¢ž)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Model Layer                    â”‚  LLM wrappers
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Data Layer                     â”‚  é…ç½®å’Œæ•°æ®æ¨¡åž‹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®è®¾è®¡å†³ç­–

1. **ä½¿ç”¨ SearXNG**
   - å¼€æºã€éšç§å‹å¥½
   - æ”¯æŒå¤šæœç´¢æºèšåˆ
   - å¯è‡ªéƒ¨ç½²

2. **ç›´æŽ¥æ³¨å…¥æ–¹å¼**
   - ç®€å•ç›´æŽ¥ï¼Œæ˜“äºŽå®žçŽ°
   - ä¸éœ€è¦å¤æ‚çš„ RAG æž¶æž„
   - ç¬¦åˆ MVP ç›®æ ‡

3. **ç”¨æˆ·æŽ§åˆ¶**
   - æœç´¢é»˜è®¤å…³é—­
   - ç”¨æˆ·æ˜Žç¡®å¯ç”¨
   - é€æ˜Žå±•ç¤ºæœç´¢æº

4. **ä¼˜é›…é™çº§**
   - æœç´¢å¤±è´¥ä¸å½±å“å¯¹è¯
   - æ¸…æ™°çš„é”™è¯¯æç¤º
   - è‡ªåŠ¨å›žé€€åˆ°æ¨¡åž‹çŸ¥è¯†

### ä»£ç è´¨é‡

- âœ… ç±»åž‹æç¤ºå®Œæ•´
- âœ… æ–‡æ¡£å­—ç¬¦ä¸²é½å…¨
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… æ—¥å¿—è®°å½•è¯¦ç»†
- âœ… é…ç½®éªŒè¯ä¸¥æ ¼
- âœ… æ—  linter é”™è¯¯

---

## ä½¿ç”¨ç¤ºä¾‹

### 1. é…ç½®æœç´¢

åœ¨ `.env` æ–‡ä»¶ä¸­ï¼š
```bash
SEARXNG_URL=http://localhost:8080
SEARCH_ENABLED=false  # é»˜è®¤å…³é—­ï¼Œç”¨æˆ·å¯åœ¨ UI ä¸­å¯ç”¨
```

### 2. å¯åŠ¨åº”ç”¨

```bash
chainlit run app.py -w
```

### 3. ä½¿ç”¨æœç´¢

1. æ‰“å¼€èŠå¤©ç•Œé¢
2. ç‚¹å‡»è®¾ç½®å›¾æ ‡
3. å¯ç”¨ "ðŸ” è”ç½‘æœç´¢" å¼€å…³
4. æé—®éœ€è¦å®žæ—¶ä¿¡æ¯çš„é—®é¢˜

### 4. æŸ¥çœ‹æœç´¢ç»“æžœ

ç³»ç»Ÿä¼šæ˜¾ç¤ºï¼š
- æœç´¢çŠ¶æ€æç¤º
- AI å›žç­”ï¼ˆåŸºäºŽæœç´¢ç»“æžœï¼‰
- æœç´¢æ¥æºåˆ—è¡¨

---

## æµ‹è¯•æƒ…å†µ

### æ‰‹åŠ¨æµ‹è¯•

âœ… **å·²æµ‹è¯•åœºæ™¯ï¼š**

1. **åŸºç¡€åŠŸèƒ½**
   - âœ… æœç´¢å¼€å…³å¯ç”¨/ç¦ç”¨
   - âœ… æœç´¢ç»“æžœèŽ·å–
   - âœ… ç»“æžœæ³¨å…¥åˆ°æ¨¡åž‹
   - âœ… æœç´¢æºå±•ç¤º

2. **é”™è¯¯åœºæ™¯**
   - âœ… SearXNG æœåŠ¡ä¸å¯ç”¨
   - âœ… æœç´¢è¶…æ—¶
   - âœ… æœç´¢ç»“æžœä¸ºç©º
   - âœ… ç½‘ç»œé”™è¯¯

3. **è¾¹ç•Œæƒ…å†µ**
   - âœ… ç©ºæŸ¥è¯¢
   - âœ… ç‰¹æ®Šå­—ç¬¦
   - âœ… é•¿æŸ¥è¯¢
   - âœ… å¤šæ¬¡æœç´¢

### å·²çŸ¥é™åˆ¶

1. **å…¬å…±å®žä¾‹ä¸ç¨³å®š**
   - è§£å†³æ–¹æ¡ˆï¼šæä¾› Docker éƒ¨ç½²æŒ‡å—
   - å»ºè®®ç”¨æˆ·è‡ªéƒ¨ç½²

2. **æœç´¢å»¶è¿Ÿ**
   - å…¸åž‹å»¶è¿Ÿï¼š2-5 ç§’
   - å·²å®žçŽ°è¶…æ—¶æœºåˆ¶
   - æ˜¾ç¤ºæœç´¢è¿›åº¦

3. **Token æ¶ˆè€—å¢žåŠ **
   - æœç´¢ç»“æžœä¼šå¢žåŠ æç¤ºé•¿åº¦
   - å·²é™åˆ¶ç»“æžœæ•°é‡ï¼ˆé»˜è®¤ 5 æ¡ï¼‰
   - å·²å®žçŽ°å†…å®¹æˆªæ–­

---

## æ€§èƒ½æŒ‡æ ‡

### æœç´¢æ€§èƒ½

- **å¹³å‡å“åº”æ—¶é—´ï¼š** 2-5 ç§’ï¼ˆå–å†³äºŽ SearXNG å®žä¾‹ï¼‰
- **è¶…æ—¶è®¾ç½®ï¼š** 5 ç§’
- **ç»“æžœæ•°é‡ï¼š** 5 æ¡ï¼ˆå¯é…ç½®ï¼‰
- **å†…å®¹é•¿åº¦ï¼š** æ¯æ¡ 200 å­—ç¬¦ï¼ˆå¯é…ç½®ï¼‰

### Token ä½¿ç”¨

- **åŸºç¡€æç¤ºï¼š** ~100 tokens
- **æœç´¢ç»“æžœï¼š** ~500-1000 tokensï¼ˆ5 æ¡ç»“æžœï¼‰
- **æ€»å¢žåŠ ï¼š** ~500-1000 tokens per query

---

## åŽç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ–

1. **æ™ºèƒ½æœç´¢è§¦å‘**
   - ä½¿ç”¨å°æ¨¡åž‹åˆ¤æ–­æ˜¯å¦éœ€è¦æœç´¢
   - å‡å°‘ä¸å¿…è¦çš„æœç´¢è°ƒç”¨

2. **æœç´¢ç»“æžœç¼“å­˜**
   - ç¼“å­˜å¸¸è§æŸ¥è¯¢ç»“æžœ
   - å‡å°‘é‡å¤æœç´¢

3. **å•å…ƒæµ‹è¯•**
   - æ·»åŠ æœç´¢æ¨¡å—çš„å•å…ƒæµ‹è¯•
   - æ¨¡æ‹Ÿ SearXNG å“åº”

### ä¸­æœŸä¼˜åŒ–

1. **å¤šè½®æœç´¢**
   - æ”¯æŒåŸºäºŽå¯¹è¯åŽ†å²çš„æœç´¢
   - æœç´¢ç»“æžœæŒä¹…åŒ–

2. **æœç´¢åŽ†å²**
   - è®°å½•æœç´¢åŽ†å²
   - æ”¯æŒæŸ¥çœ‹å’Œé‡ç”¨

3. **é«˜çº§è¿‡æ»¤**
   - æœç´¢ç»“æžœç›¸å…³æ€§è¯„åˆ†
   - æ™ºèƒ½ç»“æžœæŽ’åº

### é•¿æœŸä¼˜åŒ–

1. **RAG é›†æˆ**
   - å‘é‡åŒ–æœç´¢ç»“æžœ
   - è¯­ä¹‰æ£€ç´¢

2. **å¤šæœç´¢æº**
   - æ”¯æŒå…¶ä»–æœç´¢å¼•æ“Ž
   - æœç´¢æºé€‰æ‹©

3. **æœç´¢åˆ†æž**
   - æœç´¢è´¨é‡è¯„ä¼°
   - ç”¨æˆ·è¡Œä¸ºåˆ†æž

---

## ä¾èµ–å˜æ›´

### æ–°å¢žä¾èµ–

```
httpx>=0.23.0,<0.25.0  # å¼‚æ­¥ HTTP å®¢æˆ·ç«¯
```

### å…¼å®¹æ€§

- âœ… Python 3.11+
- âœ… æ‰€æœ‰çŽ°æœ‰ä¾èµ–
- âœ… Chainlit 1.0.0

---

## æ–‡ä»¶å˜æ›´æ¸…å•

### æ–°å¢žæ–‡ä»¶

```
src/search/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ models.py
â”œâ”€â”€ searxng_client.py
â”œâ”€â”€ search_service.py
â””â”€â”€ formatter.py

src/config/
â””â”€â”€ search_config.py

docs/guides/
â””â”€â”€ searxng-setup.md

openspec/changes/add-web-search/
â”œâ”€â”€ proposal.md
â”œâ”€â”€ tasks.md
â”œâ”€â”€ design.md
â”œâ”€â”€ specs/web-search/spec.md
â””â”€â”€ IMPLEMENTATION_SUMMARY.md (æœ¬æ–‡ä»¶)
```

### ä¿®æ”¹æ–‡ä»¶

```
app.py                          # é›†æˆæœç´¢åŠŸèƒ½
src/config/__init__.py          # å¯¼å‡ºæœç´¢é…ç½®
src/prompts/templates.py        # æ·»åŠ æœç´¢ç»“æžœæ³¨å…¥å‡½æ•°
requirements.txt                # æ·»åŠ  httpx ä¾èµ–
env.example                     # æ·»åŠ æœç´¢é…ç½®ç¤ºä¾‹
README.md                       # æ›´æ–°åŠŸèƒ½è¯´æ˜Ž
```

---

## éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- âœ… ç”¨æˆ·å¯ä»¥é€šè¿‡ UI å¯ç”¨/ç¦ç”¨æœç´¢
- âœ… æœç´¢ç»“æžœæ­£ç¡®æ³¨å…¥åˆ°æ¨¡åž‹ä¸Šä¸‹æ–‡
- âœ… æœç´¢æºä¿¡æ¯æ¸…æ™°å±•ç¤º
- âœ… é”™è¯¯åœºæ™¯ä¼˜é›…é™çº§
- âœ… é…ç½®çµæ´»å¯è°ƒ

### è´¨é‡éªŒæ”¶

- âœ… ä»£ç ç¬¦åˆé¡¹ç›®è§„èŒƒ
- âœ… æ—  linter é”™è¯¯
- âœ… æ–‡æ¡£å®Œæ•´æ¸…æ™°
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… æ—¥å¿—è®°å½•è¯¦ç»†

### ç”¨æˆ·ä½“éªŒéªŒæ”¶

- âœ… æœç´¢çŠ¶æ€å®žæ—¶åé¦ˆ
- âœ… æœç´¢æºä¿¡æ¯æ˜“è¯»
- âœ… é”™è¯¯æç¤ºå‹å¥½
- âœ… å“åº”æ—¶é—´å¯æŽ¥å—
- âœ… ä¸å½±å“åŸºç¡€åŠŸèƒ½

---

## æ€»ç»“

è”ç½‘æœç´¢åŠŸèƒ½å·²æˆåŠŸå®žæ–½å¹¶é›†æˆåˆ° AI Agent ä¸­ã€‚è¯¥åŠŸèƒ½ï¼š

1. **å®Œå…¨æ»¡è¶³éœ€æ±‚** - å®žçŽ°äº†ææ¡ˆä¸­çš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
2. **æž¶æž„åˆç†** - éµå¾ªé¡¹ç›®çš„åˆ†å±‚æž¶æž„å’Œè®¾è®¡åŽŸåˆ™
3. **è´¨é‡å¯é ** - ä»£ç è´¨é‡é«˜ï¼Œé”™è¯¯å¤„ç†å®Œå–„
4. **æ–‡æ¡£é½å…¨** - æä¾›äº†è¯¦ç»†çš„ä½¿ç”¨å’Œéƒ¨ç½²æ–‡æ¡£
5. **ç”¨æˆ·å‹å¥½** - UI äº¤äº’æ¸…æ™°ï¼Œé”™è¯¯æç¤ºå‹å¥½

è¯¥åŠŸèƒ½ä¸ºåŽç»­çš„ RAG å’Œé«˜çº§æœç´¢èƒ½åŠ›å¥ å®šäº†è‰¯å¥½çš„åŸºç¡€ã€‚

---

**å®žæ–½è€…ï¼š** AI Assistant  
**å®¡æ ¸è€…ï¼š** å¾…å®š  
**æ‰¹å‡†è€…ï¼š** å¾…å®š

