# Agent 模式提案

## 概述

本提案旨在为系统添加 **Agent 模式**,实现基于 ReAct (Reasoning + Acting) 模式的智能助手功能。Agent 模式将让 LLM 自主决策何时需要搜索、搜索什么内容,以及是否需要再次搜索,从而提供更智能和透明的对话体验。

## 核心功能

### 1. 两种对话模式

#### Chat 模式 (现有增强)
- 保持现有的对话体验
- 用户手动控制是否启用联网搜索
- 适合简单的问答场景
- 响应快速,成本可控

#### Agent 模式 (新增)
- LLM 自主决策是否需要搜索
- 支持多轮搜索迭代
- 完整的 ReAct 循环: 思考 → 行动 → 观察 → 再思考
- 决策过程完全可视化
- 适合复杂问题和需要实时信息的场景

### 2. ReAct 循环

```
用户提问
    ↓
💭 Reasoning (思考)
    ├─ 分析问题
    ├─ 判断是否需要搜索
    └─ 决定下一步行动
    ↓
🔍 Acting (行动)
    ├─ 生成搜索查询
    └─ 调用搜索工具
    ↓
📝 Observing (观察)
    ├─ 接收搜索结果
    └─ 分析结果是否充分
    ↓
💭 Reasoning (再思考)
    ├─ 需要更多信息? → 返回 Acting
    └─ 信息充分? → 生成最终回答
    ↓
📄 最终回答
```

### 3. 执行过程可视化

使用 Chainlit Step 组件展示:
- ✅ 思考过程 (自动折叠)
- ✅ 工具调用 (显示搜索查询)
- ✅ 搜索结果 (显示找到的信息)
- ✅ 最终回答 (完整展示)

### 4. LangChain 集成

- 使用 LangChain ReAct Agent 框架
- 将搜索封装为 LangChain Tool
- 利用 LangChain 的回调机制实现流式展示
- 遵循 LangChain 最佳实践

## 技术架构

### 新增模块

```
src/agents/
├── __init__.py
├── base.py              # Agent 基础类
├── react_agent.py       # ReAct Agent 实现
└── tools/
    ├── __init__.py
    └── search_tool.py   # 搜索工具封装
```

### 配置管理

```bash
# 新增环境变量
DEFAULT_MODE=chat                # 默认模式
AGENT_MAX_ITERATIONS=5           # 最大迭代次数
AGENT_MAX_EXECUTION_TIME=60      # 最大执行时间(秒)
AGENT_VERBOSE=true               # 详细日志
```

### UI 组件

- **模式选择器**: Select 组件,位于设置面板
- **搜索开关**: Agent 模式下自动禁用
- **执行步骤**: 使用 Chainlit Step 展示过程
- **状态指示**: 清晰显示当前模式

## 规范变更

### 新增规范
- **agent-mode**: 定义 Agent 模式的完整功能
  - Agent 模式基础
  - ReAct 循环实现
  - 搜索工具封装
  - 配置管理
  - 错误处理
  - 性能优化

### 修改规范

#### model-invocation
- 添加模式选择功能
- 添加模式切换逻辑
- 添加模式状态管理
- 更新 UI 组件

#### web-search
- 支持 Agent 工具接口
- 搜索开关在 Agent 模式下禁用
- 添加搜索结果缓存
- 改进工具描述

## 使用场景

### Chat 模式适用场景
- ✅ 简单的问答
- ✅ 闲聊对话
- ✅ 创意写作
- ✅ 代码生成
- ✅ 不需要实时信息的场景

### Agent 模式适用场景
- ✅ 需要最新信息的问题 (如新闻、天气)
- ✅ 需要验证事实的场景
- ✅ 复杂的研究问题
- ✅ 需要多次迭代搜索的任务
- ✅ 用户想了解 AI 决策过程的场景

## 成本和性能

### 预期影响

| 指标 | Chat 模式 | Agent 模式 |
|------|-----------|-----------|
| Token 消耗 | 基准 | 2-3x |
| 响应延迟 | 5-10秒 | 20-60秒 |
| 搜索次数 | 0 或 1 | 1-5 |
| 可预测性 | 高 | 中 |
| 成本 | 低 | 中-高 |

### 成本控制措施
- ✅ 限制最大迭代次数 (默认 5 次)
- ✅ 设置最大执行时间 (默认 60 秒)
- ✅ 实现搜索结果缓存
- ✅ 在 UI 中显示 token 消耗
- ✅ 提供 Chat 模式作为替代

## 风险和缓解

### 主要风险

1. **Token 消耗增加**
   - 风险: Agent 模式可能产生显著的额外成本
   - 缓解: 限制迭代次数,提供成本提示,保留 Chat 模式

2. **响应延迟增加**
   - 风险: 多轮思考和搜索增加等待时间
   - 缓解: 实时展示进度,设置超时限制,优化性能

3. **行为不可预测**
   - 风险: Agent 可能做出意外决策
   - 缓解: 精心设计 Prompt,严格的停止条件,详细日志

4. **系统复杂度提升**
   - 风险: 代码变得更难维护
   - 缓解: 清晰的模块划分,充分的文档,保持向后兼容

## 实施计划

### 第 1 阶段: 基础架构 (3-5 天)
- [ ] 创建 Agent 目录结构
- [ ] 实现基础 Agent 类
- [ ] 实现搜索工具封装
- [ ] 编写单元测试

### 第 2 阶段: LangChain 集成 (3-5 天)
- [ ] 集成 LangChain ReAct Agent
- [ ] 实现回调机制
- [ ] 配置 Prompt 模板
- [ ] 测试 Agent 执行流程

### 第 3 阶段: UI 集成 (2-3 天)
- [ ] 添加模式选择器
- [ ] 实现执行过程可视化
- [ ] 集成到 app.py
- [ ] 测试用户交互

### 第 4 阶段: 优化和文档 (2-3 天)
- [ ] 性能优化
- [ ] 错误处理完善
- [ ] 编写用户文档
- [ ] 更新配置示例

### 总计: 10-16 天

## 成功标准

### 功能性
- ✅ Agent 能够自主决策是否需要搜索
- ✅ 支持多轮搜索迭代
- ✅ 执行过程在 UI 中清晰展示
- ✅ Chat 模式保持向后兼容

### 性能
- ✅ Agent 执行时间 < 60 秒 (90% 的情况)
- ✅ UI 响应流畅,无卡顿
- ✅ 内存使用合理 (< 500MB)

### 用户体验
- ✅ 模式切换直观易用
- ✅ 执行过程透明可理解
- ✅ 错误信息友好有帮助

### 质量
- ✅ 无严重 Bug
- ✅ 通过所有测试用例
- ✅ 代码覆盖率 > 70% (新增代码)
- ✅ 文档完整准确

## 下一步

1. **审查提案**: 团队审查本提案,提出反馈
2. **批准实施**: 获得批准后开始实施
3. **迭代开发**: 按照实施计划逐步完成
4. **测试验证**: 在每个阶段进行充分测试
5. **发布上线**: 完成后归档变更,更新文档

## 相关文档

- [proposal.md](./proposal.md) - 详细的变更提案
- [design.md](./design.md) - 技术设计文档
- [tasks.md](./tasks.md) - 详细的实施任务清单
- [specs/agent-mode/spec.md](./specs/agent-mode/spec.md) - Agent 模式规范
- [specs/model-invocation/spec.md](./specs/model-invocation/spec.md) - 模式选择规范变更
- [specs/web-search/spec.md](./specs/web-search/spec.md) - 搜索服务规范变更

## 验证

```bash
# 验证提案格式
openspec validate add-agent-mode --strict

# 查看提案详情
openspec show add-agent-mode

# 查看规范变更
openspec show add-agent-mode --json --deltas-only
```

---

**提案状态**: ✅ 已创建,等待审批  
**创建日期**: 2025-12-28  
**预计工作量**: 10-16 天  
**风险等级**: 中等

