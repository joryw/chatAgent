# model-invocation 规范变更

## MODIFIED Requirements

### Requirement: Chainlit界面集成
系统必须（SHALL）通过Chainlit界面提供交互式测试和验证能力,包括推理内容的流式展示和自动折叠。

#### Scenario: 对话式测试界面
- **WHEN** 用户通过Chainlit界面发送消息
- **THEN** 系统调用配置的模型生成响应
- **AND** 在界面上显示响应内容和元数据（令牌数、耗时等）

#### Scenario: 模型切换功能
- **WHEN** 用户在界面上选择不同的模型提供商
- **THEN** 系统切换到相应的模型
- **AND** 后续对话使用新选择的模型

#### Scenario: 参数调节功能
- **WHEN** 用户调整模型参数（temperature、max_tokens）
- **THEN** 系统应用新参数到模型调用
- **AND** 在界面上反馈参数更改状态

#### Scenario: 错误展示
- **WHEN** 模型调用发生错误
- **THEN** 系统在Chainlit界面上显示友好的错误消息
- **AND** 提供错误原因和解决建议

#### Scenario: 推理内容流式展示
- **WHEN** 使用支持推理的模型(如 DeepSeek Reasoner)生成响应
- **THEN** 系统创建展开的 Step 组件展示思考过程
- **AND** 实时流式显示思考内容的每个字符
- **AND** 使用清晰的视觉指示(如 "💭 思考中...")标识当前状态

#### Scenario: 思考内容自动折叠
- **WHEN** 模型完成思考并开始生成正式回答
- **THEN** 系统自动将思考内容折叠
- **AND** 更新视觉指示为完成状态(如 "💡 思考过程")
- **AND** 用户可以随时点击展开查看思考内容
- **AND** 确保折叠操作只执行一次,避免重复

#### Scenario: 正式回答流式输出
- **WHEN** 思考内容折叠后,模型继续生成正式回答
- **THEN** 系统在独立的消息框中流式显示回答内容
- **AND** 用户能够清晰区分思考过程和最终回答
- **AND** 保持流畅的阅读体验

#### Scenario: 思考过程异常处理
- **WHEN** 在思考内容展示过程中发生错误
- **THEN** 系统确保 Step 组件正确关闭
- **AND** 显示友好的错误提示
- **AND** 不影响后续的对话功能

## ADDED Requirements

### Requirement: 推理内容状态管理
系统必须（SHALL）可靠地管理推理内容的展示状态,确保状态转换的原子性和一致性。

#### Scenario: 状态标记跟踪
- **WHEN** 系统创建思考内容 Step 组件
- **THEN** 系统初始化状态为展开(expanded)
- **AND** 使用内部标记跟踪折叠状态
- **AND** 防止重复执行折叠操作

#### Scenario: 状态转换触发
- **WHEN** 系统接收到第一个正式回答 chunk
- **THEN** 系统立即触发思考内容折叠
- **AND** 同步更新所有相关的视觉指示
- **AND** 记录状态转换日志用于调试

#### Scenario: 生命周期管理
- **WHEN** 思考内容 Step 不再需要时
- **THEN** 系统正确关闭 Step 的上下文管理器
- **AND** 释放相关资源
- **AND** 确保在异常情况下也能正确清理

