# 快速参考: 改进推理内容流式展示

## 🎯 一句话总结

优化 DeepSeek Reasoner 模型的思考过程展示,让思考内容在流式输出时展开可见,完成后自动折叠,提升用户体验。

## 📋 核心改进

| 改进项 | 现状 | 目标 | 实现方式 |
|--------|------|------|----------|
| **展开状态** | 可能不明确 | 思考时明确展开 | `collapsed=False` + update |
| **折叠时机** | 可能延迟 | 第一个回答 chunk | 检测 `chunk_type=="answer"` |
| **视觉反馈** | 单一状态 | 区分思考/完成 | "💭 思考中..." → "💡 思考过程" |
| **状态管理** | 可能重复 | 幂等操作 | `_collapsed_already` 标记 |

## 🔧 关键代码位置

| 文件 | 行数范围 | 说明 |
|------|---------|------|
| `app.py` | 436-448 | 创建和更新 thinking_step |
| `app.py` | 450-471 | 处理回答和折叠逻辑 |
| `app.py` | 473-478 | 确保 Step 正确关闭 |

## 📊 状态流转

```
开始 → 💭 思考中... (展开) → 流式更新 → 💡 思考过程 (折叠) → 显示回答 → 完成
```

## ✅ 实施检查清单

- [ ] 1. 优化 Step 创建逻辑 (明确展开)
- [ ] 2. 改进折叠触发机制 (第一个 answer chunk)
- [ ] 3. 增强视觉反馈 (图标和名称)
- [ ] 4. 添加状态标记 (`_collapsed_already`)
- [ ] 5. 改进错误处理 (确保 Step 关闭)
- [ ] 6. 功能测试 (各种场景)
- [ ] 7. 边界测试 (异常情况)
- [ ] 8. 用户体验验证 (流畅度)

## 🧪 测试场景

1. **正常流程**: 思考 → 回答 → 折叠
2. **只有思考**: 只有 reasoning chunks
3. **网络中断**: 流式传输中断
4. **快速切换**: 多次请求切换

## 📖 文档导航

- 📄 [完整提案](./proposal.md) - 为什么要做这个改进
- 🏗️ [技术设计](./design.md) - 详细的技术方案
- ✅ [任务清单](./tasks.md) - 实施步骤
- 📐 [规范变更](./specs/model-invocation/spec.md) - OpenSpec 规范更新
- 📚 [总览文档](./README.md) - 完整的项目概述

## 🚀 快速开始

```bash
# 1. 查看提案
openspec show improve-reasoning-display

# 2. 验证提案
openspec validate improve-reasoning-display --strict

# 3. 查看变更详情
openspec show improve-reasoning-display --json --deltas-only

# 4. 开始实施
# 按照 tasks.md 中的清单逐步完成
```

## 💡 关键决策

1. **使用 Chainlit Step**: 原生支持,无需自定义组件
2. **第一个 answer chunk 折叠**: 明确的状态转换时机
3. **内部标记跟踪**: 简单可靠的幂等性保证
4. **视觉图标区分**: 符合用户心智模型

## ⚠️ 注意事项

- 不改变 API 接口或配置
- 不影响其他模型的使用
- 向后兼容现有实现
- 可以随时回退代码

---

**验证状态**: ✅ 通过  
**复杂度**: 🟢 低 (单文件修改)  
**风险等级**: 🟢 低 (体验优化)  
**预计工时**: ~4 小时

