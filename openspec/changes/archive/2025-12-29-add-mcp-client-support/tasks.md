# 实现任务清单

## 1. 规范定义
- [ ] 1.1 编写 mcp-client 规范 delta
- [ ] 1.2 编写 agent-mode 规范 delta（添加 MCP 工具支持）
- [ ] 1.3 验证规范格式 (`openspec validate add-mcp-client-support --strict`)

## 2. MCP Client 基础实现
- [ ] 2.1 创建 `src/mcp/` 目录结构
- [ ] 2.2 实现 MCP 数据模型 (`src/mcp/models.py`)
  - [ ] 定义 MCP 工具模型
  - [ ] 定义 MCP 请求/响应模型
  - [ ] 定义 MCP 错误模型
- [ ] 2.3 实现 MCP Client 核心 (`src/mcp/client.py`)
  - [ ] 支持 SSE 连接方式
  - [ ] 支持 HTTP 连接方式
  - [ ] 实现工具列表查询
  - [ ] 实现工具调用
  - [ ] 实现错误处理和重试
- [ ] 2.4 实现工具适配器 (`src/mcp/tool_adapter.py`)
  - [ ] 将 MCP 工具转换为 LangChain Tool
  - [ ] 处理工具参数映射
  - [ ] 处理工具返回值格式化

## 3. 配置管理
- [ ] 3.1 创建 MCP 配置模块 (`src/config/mcp_config.py`)
  - [ ] 定义 MCP 服务器配置模型
  - [ ] 支持从环境变量读取配置
  - [ ] 支持从配置文件读取配置（可选）
- [ ] 3.2 添加高德地图 MCP 配置
  - [ ] 配置高德地图 MCP 服务器 URL
  - [ ] 配置 API Key
- [ ] 3.3 更新 `env.example` 文件
  - [ ] 添加 MCP 相关环境变量示例

## 4. MCP Client 初始化
- [ ] 4.1 在应用启动时初始化 MCP Client
  - [ ] 读取 MCP 服务器配置
  - [ ] 连接到 MCP 服务器
  - [ ] 发现可用工具
- [ ] 4.2 实现 MCP Client 缓存机制
  - [ ] 避免重复初始化
  - [ ] 支持连接复用

## 5. 工具集成
- [ ] 5.1 修改 Agent 工具注册机制
  - [ ] 支持动态添加 MCP 工具
  - [ ] 保持现有搜索工具功能
- [ ] 5.2 在 Agent 初始化时注册 MCP 工具
  - [ ] 获取 MCP Client 发现的工具列表
  - [ ] 转换为 LangChain Tool
  - [ ] 添加到 Agent 工具列表
- [ ] 5.3 实现工具调用路由
  - [ ] 区分本地工具和 MCP 工具
  - [ ] 正确路由到对应的执行器

## 6. 高德地图工具集成
- [ ] 6.1 测试高德地图 MCP 服务器连接
- [ ] 6.2 验证可用工具列表
- [ ] 6.3 测试关键工具功能
  - [ ] 路径规划工具
  - [ ] 地点搜索工具
  - [ ] 地理编码工具
  - [ ] 天气查询工具

## 7. 错误处理
- [ ] 7.1 实现 MCP 连接错误处理
  - [ ] 连接失败时的降级策略
  - [ ] 超时处理
- [ ] 7.2 实现工具调用错误处理
  - [ ] API 错误处理
  - [ ] 参数验证错误处理
  - [ ] 返回错误信息给 Agent
- [ ] 7.3 实现重试机制
  - [ ] 网络错误重试
  - [ ] 可配置的重试次数和间隔

## 8. 日志和监控
- [ ] 8.1 添加 MCP Client 日志
  - [ ] 连接日志
  - [ ] 工具发现日志
  - [ ] 工具调用日志
- [ ] 8.2 添加性能监控
  - [ ] 工具调用耗时统计
  - [ ] 错误率统计

## 9. 测试和验证
- [ ] 9.1 单元测试
  - [ ] MCP Client 连接测试
  - [ ] 工具转换测试
  - [ ] 错误处理测试
- [ ] 9.2 集成测试
  - [ ] Agent 使用 MCP 工具测试
  - [ ] 高德地图工具端到端测试
- [ ] 9.3 手动测试
  - [ ] 测试路径规划功能
  - [ ] 测试地点搜索功能
  - [ ] 测试地理编码功能
  - [ ] 测试天气查询功能

## 10. 文档更新
- [ ] 10.1 更新 README.md
  - [ ] 添加 MCP Client 说明
  - [ ] 添加高德地图集成说明
- [ ] 10.2 创建 MCP 使用指南
  - [ ] MCP 配置说明
  - [ ] 可用工具列表
  - [ ] 使用示例
- [ ] 10.3 更新环境变量文档
  - [ ] MCP 相关环境变量说明

## 11. 依赖管理
- [ ] 11.1 添加 MCP SDK 依赖
  - [ ] 检查 `requirements.txt`
  - [ ] 添加 `mcp` 包（如果存在）
  - [ ] 或实现自定义 MCP Client
- [ ] 11.2 添加 HTTP/SSE 客户端依赖
  - [ ] 检查是否需要额外的 HTTP 客户端库

## 12. 性能优化
- [ ] 12.1 实现工具调用缓存（可选）
- [ ] 12.2 优化连接池管理
- [ ] 12.3 优化工具发现流程

## 13. 提交和归档
- [ ] 13.1 提交所有代码变更
- [ ] 13.2 运行最终验证
- [ ] 13.3 准备归档材料
- [ ] 13.4 执行 `openspec archive add-mcp-client-support`

