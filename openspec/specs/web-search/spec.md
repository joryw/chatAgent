# web-search Specification

## Purpose
TBD - created by archiving change add-web-search. Update Purpose after archive.
## Requirements
### Requirement: 搜索开关控制
系统 SHALL 在聊天界面提供联网搜索开关,允许用户通过UI控件或命令两种方式启用或禁用搜索功能。

#### Scenario: 通过UI开关启用搜索
- **WHEN** 用户在聊天设置面板中打开"联网搜索"开关
- **THEN** 系统将在后续对话中启用搜索功能
- **AND** 系统发送消息确认"联网搜索 ✅ 已启用"
- **AND** UI开关显示为开启状态

#### Scenario: 通过UI开关禁用搜索
- **WHEN** 用户在聊天设置面板中关闭"联网搜索"开关
- **THEN** 系统将在后续对话中禁用搜索功能
- **AND** 系统发送消息确认"联网搜索 ❌ 已禁用"
- **AND** UI开关显示为关闭状态

#### Scenario: 通过命令启用搜索
- **WHEN** 用户发送 `/search on` 命令
- **THEN** 系统启用搜索功能
- **AND** 系统发送确认消息
- **AND** UI开关状态同步更新为开启

#### Scenario: 通过命令禁用搜索
- **WHEN** 用户发送 `/search off` 命令
- **THEN** 系统禁用搜索功能
- **AND** 系统发送确认消息
- **AND** UI开关状态同步更新为关闭

#### Scenario: 默认状态
- **WHEN** 用户首次进入聊天界面
- **THEN** 搜索开关默认为关闭状态
- **AND** UI控件显示为关闭
- **AND** 欢迎消息中说明搜索开关的位置和用法

#### Scenario: 搜索服务不可用时的UI状态
- **WHEN** SearXNG 搜索服务不可用或未配置
- **THEN** UI开关显示为禁用状态(灰色/不可点击)
- **AND** 开关的描述文本说明"搜索服务不可用"
- **AND** 欢迎消息中显示配置指南链接
- **AND** 用户尝试通过命令启用搜索时收到不可用提示

#### Scenario: UI和命令状态同步
- **WHEN** 用户通过任一方式(UI或命令)修改搜索状态
- **THEN** 另一种方式的状态显示应当立即同步
- **AND** `/config` 命令显示的状态与UI开关一致
- **AND** 实际搜索行为与显示的状态一致

### Requirement: SearXNG 集成
系统 SHALL 集成本地部署的 SearXNG 搜索引擎,提供稳定可靠的联网搜索能力。

#### Scenario: 使用本地 SearXNG 实例
- **WHEN** 系统启动时
- **THEN** 应当连接到本地部署的 SearXNG 实例
- **AND** 默认地址为 `http://localhost:8080`
- **AND** 验证实例的可用性和配置正确性

#### Scenario: 成功搜索
- **WHEN** 系统需要执行搜索且本地 SearXNG 服务可用
- **THEN** 系统向本地 SearXNG 实例发送搜索请求
- **AND** 接收并解析 JSON 格式的搜索结果(包括标题、URL、摘要)

#### Scenario: 搜索超时
- **WHEN** 搜索请求超过5秒未返回
- **THEN** 系统应当终止搜索请求
- **AND** 降级到无搜索模式继续对话
- **AND** 在界面显示搜索超时提示

#### Scenario: 服务不可用
- **WHEN** 本地 SearXNG 服务不可达或返回错误
- **THEN** 系统应当捕获错误
- **AND** 降级到无搜索模式继续对话
- **AND** 在界面显示搜索服务不可用提示
- **AND** 提示用户检查 SearXNG 部署状态

#### Scenario: 配置验证失败
- **WHEN** 本地 SearXNG 实例配置不正确(如未启用 JSON 格式)
- **THEN** 系统应当在启动时检测配置问题
- **AND** 显示具体的配置错误信息
- **AND** 提供配置修复建议和文档链接

### Requirement: 搜索触发机制
当搜索功能启用时,系统 SHALL 在适当时机触发搜索。

#### Scenario: 用户发送消息时触发搜索
- **WHEN** 用户启用了搜索功能并发送新消息
- **THEN** 系统应当基于用户消息内容触发搜索
- **AND** 在界面显示搜索进行中的状态

#### Scenario: 搜索功能未启用
- **WHEN** 用户未启用搜索功能
- **THEN** 系统不应触发任何搜索请求
- **AND** 直接使用模型生成回答

### Requirement: 搜索结果处理
系统 SHALL 处理搜索结果并将其提供给语言模型。

#### Scenario: 注入搜索结果到提示
- **WHEN** 搜索成功返回结果
- **THEN** 系统应当格式化搜索结果(包含标题、来源、摘要)
- **AND** 将格式化后的结果注入到模型提示中
- **AND** 提示模型参考搜索结果回答用户问题

#### Scenario: 搜索结果为空
- **WHEN** 搜索未返回任何结果
- **THEN** 系统应当在提示中说明未找到相关信息
- **AND** 提示模型基于自身知识回答

#### Scenario: 限制结果数量
- **WHEN** 搜索返回大量结果
- **THEN** 系统应当只选择前3-5条最相关的结果
- **AND** 对每条结果的摘要进行截断(最多200字符)

### Requirement: 搜索源展示
系统 SHALL 在聊天界面展示搜索来源信息,提高透明度。

#### Scenario: 展示搜索源列表
- **WHEN** 模型回答基于搜索结果
- **THEN** 系统应当在回答下方展示使用的搜索源
- **AND** 每个搜索源包含标题、URL和简短摘要
- **AND** 搜索源以可点击链接形式展示

#### Scenario: 无搜索源
- **WHEN** 回答未使用搜索结果
- **THEN** 系统不应展示搜索源信息

#### Scenario: 搜索源引用标记
- **WHEN** 模型在回答中引用特定搜索结果
- **THEN** 系统应当在引用处添加上标序号标记
- **AND** 序号对应搜索源列表中的顺序

### Requirement: 搜索配置
系统 SHALL 支持配置本地 SearXNG 实例相关参数。

#### Scenario: SearXNG 服务地址配置
- **WHEN** 系统启动时
- **THEN** 从环境变量读取 SearXNG 服务地址
- **AND** 默认使用本地地址 `http://localhost:8080`
- **AND** 验证服务地址的格式有效性
- **AND** 执行健康检查确认服务可用

#### Scenario: 搜索参数配置
- **WHEN** 系统初始化搜索配置时
- **THEN** 应当加载以下可配置参数:
  - 搜索结果数量(默认5条)
  - 搜索超时时间(默认5秒)
  - 搜索语言偏好(默认自动)
  - 结果摘要最大长度(默认200字符)

#### Scenario: 配置验证
- **WHEN** 加载搜索配置时
- **THEN** 系统应当验证配置值的有效性
- **AND** 对于无效配置使用默认值
- **AND** 记录配置加载日志
- **AND** 检查 SearXNG 实例的 JSON API 是否启用

#### Scenario: 部署指引
- **WHEN** 检测到 SearXNG 服务不可用
- **THEN** 系统应当显示部署指引信息
- **AND** 提供部署文档的链接
- **AND** 说明 Docker 部署的基本步骤

### Requirement: 错误处理与降级
系统 SHALL 优雅地处理搜索功能的错误,不影响基础对话能力。

#### Scenario: 搜索失败降级
- **WHEN** 搜索功能出现任何错误(超时、服务不可用、解析失败等)
- **THEN** 系统应当记录错误日志
- **AND** 降级到无搜索模式
- **AND** 继续正常对话流程
- **AND** 向用户显示友好的错误提示

#### Scenario: 部分搜索结果失败
- **WHEN** 部分搜索结果无法解析或格式错误
- **THEN** 系统应当跳过错误的结果
- **AND** 使用成功解析的结果继续处理
- **AND** 在日志中记录解析失败的详情

#### Scenario: 网络连接问题
- **WHEN** 因网络问题无法连接 SearXNG 服务
- **THEN** 系统应当快速失败(不超过5秒)
- **AND** 显示网络连接问题提示
- **AND** 建议用户检查网络或关闭搜索功能

### Requirement: SearXNG 部署支持
系统 SHALL 提供完整的 SearXNG 本地部署指南和支持。

#### Scenario: 提供部署文档
- **WHEN** 用户需要部署 SearXNG
- **THEN** 系统应当提供详细的部署文档
- **AND** 文档包含 Docker Compose 配置示例
- **AND** 文档说明必要的 settings.yml 配置项
- **AND** 文档包含启动和验证步骤

#### Scenario: 配置模板提供
- **WHEN** 用户需要配置 SearXNG
- **THEN** 系统应当提供 docker-compose.yml 模板
- **AND** 提供 settings.yml 配置模板
- **AND** 模板包含所有必要的配置项
- **AND** 模板启用 JSON 格式和 API 支持

#### Scenario: 健康检查端点
- **WHEN** 用户需要验证 SearXNG 部署
- **THEN** 系统应当提供健康检查功能
- **AND** 验证服务是否可访问
- **AND** 验证 JSON API 是否可用
- **AND** 返回明确的检查结果和建议

### Requirement: 部署故障排查
系统 SHALL 提供 SearXNG 部署和配置的故障排查指导。

#### Scenario: 连接失败诊断
- **WHEN** 无法连接到 SearXNG 服务
- **THEN** 系统应当提示检查以下项目:
  - Docker 容器是否正在运行
  - 端口是否正确配置和开放
  - 网络连接是否正常
- **AND** 提供具体的检查命令

#### Scenario: 配置错误诊断
- **WHEN** SearXNG 配置不正确
- **THEN** 系统应当识别常见配置问题:
  - JSON 格式未启用
  - API 未启用
  - 端口配置错误
- **AND** 提供针对性的修复建议

#### Scenario: 服务重启指导
- **WHEN** 用户需要重启 SearXNG 服务
- **THEN** 系统文档应当提供重启命令
- **AND** 说明配置修改后的生效方式
- **AND** 提供验证服务恢复的方法

### Requirement: 聊天设置面板
系统 SHALL 提供聊天设置面板,允许用户通过UI控件配置聊天功能。

#### Scenario: 设置面板初始化
- **WHEN** 用户会话开始时
- **THEN** 系统应当创建并显示聊天设置面板
- **AND** 设置面板包含"联网搜索"开关控件
- **AND** 设置面板位于聊天界面的固定位置(如侧边栏或顶部)

#### Scenario: 设置面板可访问性
- **WHEN** 用户需要修改设置
- **THEN** 设置面板应当始终可访问
- **AND** 不会被聊天消息遮挡
- **AND** 在移动端设备上也能正常显示和操作

#### Scenario: 搜索开关控件
- **WHEN** 设置面板显示时
- **THEN** 搜索开关控件应当包含:
  - 图标: 🔍 (搜索图标)
  - 标签: "联网搜索"
  - 描述: "启用后将使用SearXNG搜索实时信息"
  - 开关状态: 开启/关闭/禁用
- **AND** 控件状态清晰可辨

#### Scenario: 实时状态更新
- **WHEN** 用户切换UI开关
- **THEN** 系统应当立即响应状态变化
- **AND** 在500毫秒内发送状态确认消息
- **AND** 后续消息立即按新状态处理

