# web-search Specification

## Purpose
TBD - created by archiving change add-web-search. Update Purpose after archive.
## Requirements
### Requirement: 搜索开关控制
系统必须（SHALL）在 Chat 模式下提供搜索开关,在 Agent 模式下禁用开关。

#### Scenario: Chat 模式搜索开关
- **WHEN** 系统处于 Chat 模式
- **THEN** 搜索开关正常可用
- **AND** 用户可以通过 UI 或命令控制
- **AND** 功能与现有实现完全一致

#### Scenario: Agent 模式搜索开关
- **WHEN** 系统处于 Agent 模式
- **THEN** 搜索开关显示为禁用状态
- **AND** 用户无法点击或切换
- **AND** 显示说明: "Agent 模式下由 AI 自动决策搜索"

#### Scenario: 模式切换时开关状态
- **WHEN** 用户从 Agent 模式切换到 Chat 模式
- **THEN** 搜索开关恢复可用状态
- **AND** 开关状态恢复为之前的设置或默认关闭
- **WHEN** 用户从 Chat 模式切换到 Agent 模式
- **THEN** 搜索开关变为禁用状态
- **AND** 保存当前开关状态以便切换回 Chat 模式时恢复

### Requirement: SearXNG 集成
系统 SHALL 集成本地部署的 SearXNG 搜索引擎,提供稳定可靠的联网搜索能力。

#### Scenario: 使用本地 SearXNG 实例
- **WHEN** 系统启动时
- **THEN** 应当连接到本地部署的 SearXNG 实例
- **AND** 默认地址为 `http://localhost:8080`
- **AND** 验证实例的可用性和配置正确性

#### Scenario: 成功搜索
- **WHEN** 系统需要执行搜索且本地 SearXNG 服务可用
- **THEN** 系统向本地 SearXNG 实例发送搜索请求
- **AND** 接收并解析 JSON 格式的搜索结果(包括标题、URL、摘要)

#### Scenario: 搜索超时
- **WHEN** 搜索请求超过5秒未返回
- **THEN** 系统应当终止搜索请求
- **AND** 降级到无搜索模式继续对话
- **AND** 在界面显示搜索超时提示

#### Scenario: 服务不可用
- **WHEN** 本地 SearXNG 服务不可达或返回错误
- **THEN** 系统应当捕获错误
- **AND** 降级到无搜索模式继续对话
- **AND** 在界面显示搜索服务不可用提示
- **AND** 提示用户检查 SearXNG 部署状态

#### Scenario: 配置验证失败
- **WHEN** 本地 SearXNG 实例配置不正确(如未启用 JSON 格式)
- **THEN** 系统应当在启动时检测配置问题
- **AND** 显示具体的配置错误信息
- **AND** 提供配置修复建议和文档链接

### Requirement: 搜索触发机制
当搜索功能启用时,系统 SHALL 在适当时机触发搜索。

#### Scenario: 用户发送消息时触发搜索
- **WHEN** 用户启用了搜索功能并发送新消息
- **THEN** 系统应当基于用户消息内容触发搜索
- **AND** 在界面显示搜索进行中的状态

#### Scenario: 搜索功能未启用
- **WHEN** 用户未启用搜索功能
- **THEN** 系统不应触发任何搜索请求
- **AND** 直接使用模型生成回答

### Requirement: 搜索结果处理
系统 SHALL 处理搜索结果并将其提供给语言模型,同时支持内联引用链接功能。

#### Scenario: 注入搜索结果到提示
- **WHEN** 搜索成功返回结果
- **THEN** 系统应当格式化搜索结果(包含编号、标题、来源、摘要)
- **AND** 将格式化后的结果注入到模型提示中
- **AND** 提示模型参考搜索结果回答用户问题
- **AND** 明确指示模型使用 [数字] 格式引用来源

#### Scenario: 搜索结果为空
- **WHEN** 搜索未返回任何结果
- **THEN** 系统应当在提示中说明未找到相关信息
- **AND** 提示模型基于自身知识回答

#### Scenario: 限制结果数量
- **WHEN** 搜索返回大量结果
- **THEN** 系统应当只选择前3-5条最相关的结果
- **AND** 对每条结果的摘要进行截断(最多200字符)

#### Scenario: 引用编号分配
- **WHEN** 格式化搜索结果
- **THEN** 系统为每个搜索结果分配唯一编号
- **AND** 使用 1-based 索引(1, 2, 3...)
- **AND** 按搜索结果顺序分配编号
- **AND** 在提示词和 UI 中保持编号一致性

### Requirement: 搜索源展示
系统 SHALL 在聊天界面展示搜索来源信息,提高透明度。

#### Scenario: 展示搜索源列表
- **WHEN** 模型回答基于搜索结果
- **THEN** 系统应当在回答下方展示使用的搜索源
- **AND** 每个搜索源包含标题、URL和简短摘要
- **AND** 搜索源以可点击链接形式展示

#### Scenario: 无搜索源
- **WHEN** 回答未使用搜索结果
- **THEN** 系统不应展示搜索源信息

#### Scenario: 搜索源引用标记
- **WHEN** 模型在回答中引用特定搜索结果
- **THEN** 系统应当在引用处添加上标序号标记
- **AND** 序号对应搜索源列表中的顺序

### Requirement: 搜索配置
系统 SHALL 支持配置本地 SearXNG 实例相关参数。

#### Scenario: SearXNG 服务地址配置
- **WHEN** 系统启动时
- **THEN** 从环境变量读取 SearXNG 服务地址
- **AND** 默认使用本地地址 `http://localhost:8080`
- **AND** 验证服务地址的格式有效性
- **AND** 执行健康检查确认服务可用

#### Scenario: 搜索参数配置
- **WHEN** 系统初始化搜索配置时
- **THEN** 应当加载以下可配置参数:
  - 搜索结果数量(默认5条)
  - 搜索超时时间(默认5秒)
  - 搜索语言偏好(默认自动)
  - 结果摘要最大长度(默认200字符)

#### Scenario: 配置验证
- **WHEN** 加载搜索配置时
- **THEN** 系统应当验证配置值的有效性
- **AND** 对于无效配置使用默认值
- **AND** 记录配置加载日志
- **AND** 检查 SearXNG 实例的 JSON API 是否启用

#### Scenario: 部署指引
- **WHEN** 检测到 SearXNG 服务不可用
- **THEN** 系统应当显示部署指引信息
- **AND** 提供部署文档的链接
- **AND** 说明 Docker 部署的基本步骤

### Requirement: 错误处理与降级
系统 SHALL 优雅地处理搜索功能的错误,不影响基础对话能力。

#### Scenario: 搜索失败降级
- **WHEN** 搜索功能出现任何错误(超时、服务不可用、解析失败等)
- **THEN** 系统应当记录错误日志
- **AND** 降级到无搜索模式
- **AND** 继续正常对话流程
- **AND** 向用户显示友好的错误提示

#### Scenario: 部分搜索结果失败
- **WHEN** 部分搜索结果无法解析或格式错误
- **THEN** 系统应当跳过错误的结果
- **AND** 使用成功解析的结果继续处理
- **AND** 在日志中记录解析失败的详情

#### Scenario: 网络连接问题
- **WHEN** 因网络问题无法连接 SearXNG 服务
- **THEN** 系统应当快速失败(不超过5秒)
- **AND** 显示网络连接问题提示
- **AND** 建议用户检查网络或关闭搜索功能

### Requirement: SearXNG 部署支持
系统 SHALL 提供完整的 SearXNG 本地部署指南和支持。

#### Scenario: 提供部署文档
- **WHEN** 用户需要部署 SearXNG
- **THEN** 系统应当提供详细的部署文档
- **AND** 文档包含 Docker Compose 配置示例
- **AND** 文档说明必要的 settings.yml 配置项
- **AND** 文档包含启动和验证步骤

#### Scenario: 配置模板提供
- **WHEN** 用户需要配置 SearXNG
- **THEN** 系统应当提供 docker-compose.yml 模板
- **AND** 提供 settings.yml 配置模板
- **AND** 模板包含所有必要的配置项
- **AND** 模板启用 JSON 格式和 API 支持

#### Scenario: 健康检查端点
- **WHEN** 用户需要验证 SearXNG 部署
- **THEN** 系统应当提供健康检查功能
- **AND** 验证服务是否可访问
- **AND** 验证 JSON API 是否可用
- **AND** 返回明确的检查结果和建议

### Requirement: 部署故障排查
系统 SHALL 提供 SearXNG 部署和配置的故障排查指导。

#### Scenario: 连接失败诊断
- **WHEN** 无法连接到 SearXNG 服务
- **THEN** 系统应当提示检查以下项目:
  - Docker 容器是否正在运行
  - 端口是否正确配置和开放
  - 网络连接是否正常
- **AND** 提供具体的检查命令

#### Scenario: 配置错误诊断
- **WHEN** SearXNG 配置不正确
- **THEN** 系统应当识别常见配置问题:
  - JSON 格式未启用
  - API 未启用
  - 端口配置错误
- **AND** 提供针对性的修复建议

#### Scenario: 服务重启指导
- **WHEN** 用户需要重启 SearXNG 服务
- **THEN** 系统文档应当提供重启命令
- **AND** 说明配置修改后的生效方式
- **AND** 提供验证服务恢复的方法

### Requirement: 聊天设置面板
系统 SHALL 提供聊天设置面板,允许用户通过UI控件配置聊天功能。

#### Scenario: 设置面板初始化
- **WHEN** 用户会话开始时
- **THEN** 系统应当创建并显示聊天设置面板
- **AND** 设置面板包含"联网搜索"开关控件
- **AND** 设置面板位于聊天界面的固定位置(如侧边栏或顶部)

#### Scenario: 设置面板可访问性
- **WHEN** 用户需要修改设置
- **THEN** 设置面板应当始终可访问
- **AND** 不会被聊天消息遮挡
- **AND** 在移动端设备上也能正常显示和操作

#### Scenario: 搜索开关控件
- **WHEN** 设置面板显示时
- **THEN** 搜索开关控件应当包含:
  - 图标: 🔍 (搜索图标)
  - 标签: "联网搜索"
  - 描述: "启用后将使用SearXNG搜索实时信息"
  - 开关状态: 开启/关闭/禁用
- **AND** 控件状态清晰可辨

#### Scenario: 实时状态更新
- **WHEN** 用户切换UI开关
- **THEN** 系统应当立即响应状态变化
- **AND** 在500毫秒内发送状态确认消息
- **AND** 后续消息立即按新状态处理

### Requirement: 内联引用链接
系统必须（SHALL）将模型回答中的引用标记转换为可点击的链接,让用户能够直接跳转到来源网页。

#### Scenario: 引用标记识别
- **WHEN** 模型在回答中使用引用标记(如 [1]、[2])
- **THEN** 系统识别这些标记
- **AND** 将标记与对应的搜索结果 URL 建立映射关系

#### Scenario: 引用链接转换
- **WHEN** 模型完成回答生成
- **THEN** 系统将引用标记 [数字] 转换为 Markdown 链接 [[数字]](url)
- **AND** 只转换有效的引用编号(在搜索结果范围内)
- **AND** 保留无效引用的原始格式

#### Scenario: 引用链接点击
- **WHEN** 用户在回答中点击引用链接(如 [[1]](url))
- **THEN** 浏览器打开对应的来源网页
- **AND** 用户能够验证信息的准确性

#### Scenario: 引用列表显示
- **WHEN** 回答包含引用链接
- **THEN** 系统在回答末尾添加"参考文献"部分
- **AND** 列出所有使用的引用及其完整信息
- **AND** 包含编号、标题、URL 和域名

#### Scenario: 无引用情况
- **WHEN** 模型回答中没有使用引用标记
- **THEN** 系统不添加引用链接和引用列表
- **AND** 保持原有的搜索来源显示方式

#### Scenario: 引用编号超出范围
- **WHEN** 模型使用的引用编号超出搜索结果数量
- **THEN** 系统保留该引用的原始文本格式
- **AND** 在日志中记录警告信息
- **AND** 不影响其他有效引用的转换

### Requirement: 引用处理器
系统必须（SHALL）提供引用处理工具类,负责解析、转换和格式化引用内容。

#### Scenario: 引用映射构建
- **WHEN** 系统接收到搜索结果
- **THEN** 引用处理器构建引用编号到 URL 的映射表
- **AND** 存储标题、URL 和域名信息
- **AND** 使用编号(1, 2, 3...)作为索引

#### Scenario: 正则表达式匹配
- **WHEN** 处理器分析回答文本
- **THEN** 使用正则表达式 `\[(\d+)\]` 匹配引用标记
- **AND** 提取方括号中的数字
- **AND** 忽略非引用的方括号内容(如 [abc])

#### Scenario: 安全转换
- **WHEN** 处理器转换引用标记
- **THEN** 验证引用编号的有效性
- **AND** 只转换存在于映射表中的编号
- **AND** 处理转换失败时保持原始内容

### Requirement: 搜索结果缓存
系统必须（SHALL）在 Agent 模式下缓存搜索结果,避免重复搜索相同查询。

#### Scenario: 缓存搜索结果
- **WHEN** Agent 执行搜索并获得结果
- **THEN** 将查询和结果缓存到会话状态
- **AND** 使用查询文本作为缓存键
- **AND** 缓存在当前会话内有效

#### Scenario: 使用缓存结果
- **WHEN** Agent 尝试搜索已缓存的查询
- **THEN** 直接返回缓存的结果
- **AND** 不执行实际的搜索请求
- **AND** 在日志中记录缓存命中

#### Scenario: 缓存过期
- **WHEN** 用户会话结束
- **THEN** 清除所有缓存的搜索结果
- **AND** 新会话重新开始缓存
- **AND** 不跨会话共享缓存

#### Scenario: 缓存大小限制
- **WHEN** 缓存的查询数量超过限制 (如 20 个)
- **THEN** 使用 LRU 策略删除最久未使用的缓存
- **AND** 保持缓存大小在限制内
- **AND** 防止内存过度使用

### Requirement: 搜索工具描述
系统必须（SHALL）提供清晰的工具描述,指导 Agent 何时以及如何使用搜索。

#### Scenario: 工具名称定义
- **WHEN** 定义搜索工具
- **THEN** 工具名称为 "web_search"
- **AND** 名称清晰表明其功能
- **AND** 符合 LangChain 工具命名规范

#### Scenario: 工具描述定义
- **WHEN** 定义搜索工具描述
- **THEN** 描述说明: "搜索互联网获取实时信息。当需要了解最新事件、实时数据、当前新闻或验证信息时使用此工具。"
- **AND** 明确说明使用场景
- **AND** 帮助 Agent 做出正确决策

#### Scenario: 工具输入说明
- **WHEN** 定义工具输入 schema
- **THEN** 输入参数为 query (str)
- **AND** 参数描述: "搜索查询关键词,应该具体、清晰、针对性强"
- **AND** 提供输入示例和最佳实践

#### Scenario: 工具使用示例
- **WHEN** Agent 需要使用搜索工具
- **THEN** Prompt 中包含使用示例
- **AND** 示例展示如何构造好的搜索查询
- **AND** 示例展示如何解读搜索结果

### Requirement: 搜索结果引用
系统必须（SHALL）在 Agent 模式下支持全局连续的搜索结果引用编号，并在最终回答后展示统一的引用列表。

#### Scenario: Agent 模式结果编号分配（修改）
- **WHEN** SearchTool 在 Agent 模式下返回结果
- **THEN** 使用全局引用管理器分配编号
- **AND** 编号连续递增，不从 1 重新开始
- **AND** 工具输出中明确标注全局编号

#### Scenario: Agent 模式引用结果（修改）
- **WHEN** Agent 在回答中引用搜索结果
- **THEN** Agent 使用全局编号 [数字] 格式引用
- **AND** 系统识别并处理全局编号的引用
- **AND** 将引用转换为可点击链接

#### Scenario: Agent 模式引用列表生成（新增）
- **WHEN** Agent 回答完成
- **THEN** 系统生成统一的引用文章列表
- **AND** 列表包含所有搜索的来源信息
- **AND** 按搜索轮次分组展示
- **AND** 添加在回答末尾

#### Scenario: Chat 模式引用列表生成（保持不变）
- **WHEN** Chat 模式回答包含引用
- **THEN** 使用现有的 "参考文献" 格式
- **AND** 行为与之前完全一致
- **AND** 不使用全局引用管理器

